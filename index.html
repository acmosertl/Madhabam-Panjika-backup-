<!-- PART A: Madhabam Panchika Widget ‚Äî HTML + CSS (Blogger-safe inline) -->
<div id="madhabam-widget" style="font-family:'Noto Sans Bengali',sans-serif;max-width:480px;margin:auto;">
  <style>
    /* Inline styles ‚Äî keep UI identical to your existing look */
    #madhabam-widget *{box-sizing:border-box}
    #madhabam-root{background:#fff1dd;border-radius:14px;padding:8px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .m-title{font-weight:900;font-size:22px;text-align:center;margin:6px 2px}
    .m-toggle{position:relative;background:#f3e4b8;border-radius:999px;padding:6px;display:flex;align-items:center;gap:8px;justify-content:center}
    .m-toggle .label{font-weight:800;color:#6a5617;font-size:13px;padding:6px 8px}
    .m-toggle .slider{position:absolute;top:4px;bottom:4px;width:50%;border-radius:999px;background:#ff8a65;transition:transform .22s ease;box-shadow:0 2px 6px rgba(0,0,0,.12)}
    .m-section{background:#fff8ee;border-radius:12px;padding:10px;margin:8px 0;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .m-row{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .m-label{color:#4527a0;font-weight:900;font-size:13px}
    .m-value{font-weight:800;font-size:20px}
    .m-sub{font-size:13px;color:#333;margin-top:6px}
    .m-pill{background:#f6a9d6;border-radius:10px;padding:10px;margin:6px 0}
    .paksha{display:inline-block;background:#ffe7a1;color:#6a5617;padding:4px 10px;border-radius:999px;font-weight:900}
    .timeCol{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .timeItem{background:#fff;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,.03)}
    .t-lab{font-weight:900;color:#4527a0}
    .t-val{font-weight:900;font-size:18px}
    .progressWrap{background:linear-gradient(90deg,#fff,#fff);padding:6px;border-radius:8px;border:1px solid rgba(0,0,0,.04)}
    .progressBar{height:10px;border-radius:8px;background:linear-gradient(90deg,#ffd54f,#ff8a65);width:0%}
    .small{font-size:12px;color:#666}
    .badgeOk{display:inline-block;padding:3px 8px;border-radius:999px;background:#e0ffe7;color:#0a7a2a;font-weight:800;font-size:12px}
    .badgeWarn{display:inline-block;padding:3px 8px;border-radius:999px;background:#ffe1e1;color:#b00020;font-weight:800;font-size:12px}
    .footerSmall{text-align:center;font-size:12px;color:#666;margin-top:8px}
    /* Responsive tweaks for side panel (max 320px) */
    @media(max-width:360px){ .m-value{font-size:18px} .m-title{font-size:18px} }
  </style>

  <div id="madhabam-root">
    <div class="m-title">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶™‡¶û‡ßç‡¶ú‡¶ø‡¶ï‡¶æ</div>

    <!-- Toggle (sun-siddhanta vs drik) -->
    <div style="padding:6px 6px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div style="font-weight:900;color:#6a5617">‡¶™‡¶û‡ßç‡¶ú‡¶ø‡¶ï‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</div>
        <div id="m-location-badge" class="small">‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
      </div>
      <div class="m-toggle" id="m-toggle">
        <div class="slider" id="m-slider"></div>
        <div class="label" id="m-mode-left">‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§</div>
        <div class="label" id="m-mode-right">‡¶¶‡ßÉ‡¶ï (Govt)</div>
      </div>
      <div class="small" style="text-align:center;margin-top:6px;color:#6a5617">‡¶ü‡¶ó‡¶≤ ‡¶ï‡¶∞‡ßá ‡¶™‡¶û‡ßç‡¶ú‡¶ø‡¶ï‡¶æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>
    </div>

    <!-- 1. Paksha (with full/amu badge by emoji) -->
    <div class="m-section m-pill" id="m-paksha-card">
      <div class="m-row">
        <div class="m-label">‡¶™‡¶ï‡ßç‡¶∑</div>
        <div class="paksha" id="m-paksha-val">‚Äî</div>
      </div>
      <div class="m-sub" id="m-paksha-sub"></div>
    </div>

    <!-- 2. Tithi -->
    <div class="m-section" id="m-tithi-card">
      <div class="m-row">
        <div>
          <div class="m-label">‡¶§‡¶ø‡¶•‡¶ø</div>
          <div class="m-value" id="m-tithi-val">‚Äî</div>
        </div>
        <div style="text-align:right">
          <div class="small">‡¶∂‡ßá‡¶∑ ‡¶π‡¶¨‡ßá:</div>
          <div id="m-tithi-end" class="m-sub">‚Äî</div>
        </div>
      </div>
      <div class="small" style="margin-top:8px">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ: <span id="m-tithi-next" style="font-weight:900"></span></div>
    </div>

    <!-- 3. Nakshatra -->
    <div class="m-section" id="m-nak-card">
      <div class="m-row">
        <div>
          <div class="m-label">‡¶®‡¶ï‡ßç‡¶∑‡¶§‡ßç‡¶∞</div>
          <div class="m-value" id="m-nak-val">‚Äî</div>
        </div>
        <div style="text-align:right">
          <div class="small">‡¶∂‡ßá‡¶∑ ‡¶π‡¶¨‡ßá:</div>
          <div id="m-nak-end" class="m-sub">‚Äî</div>
        </div>
      </div>
      <div class="small" style="margin-top:8px">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ: <span id="m-nak-next" style="font-weight:900"></span></div>
    </div>

    <!-- 4. Lagna -->
    <div class="m-section" id="m-lagna-card">
      <div class="m-row">
        <div>
          <div class="m-label">‡¶≤‡¶ó‡ßç‡¶®</div>
          <div class="m-value" id="m-lagna-val">‚Äî</div>
        </div>
        <div style="text-align:right">
          <div class="small">‡¶°‡¶ø‡¶ó‡ßç‡¶∞‡¶ø</div>
          <div id="m-lagna-deg" class="m-sub">‚Äî</div>
        </div>
      </div>
      <div class="small" style="margin-top:8px">‡¶∂‡ßá‡¶∑ ‡¶π‡¶¨‡ßá: <span id="m-lagna-end" style="font-weight:900">‚Äî</span></div>
    </div>

    <!-- 5. Rashi + Moon progress -->
    <div class="m-section" id="m-rashi-card">
      <div class="m-row">
        <div>
          <div class="m-label">‡¶∞‡¶æ‡¶∂‡¶ø (‡¶ö‡¶æ‡¶Å‡¶¶)</div>
          <div class="m-value" id="m-rashi-val">‚Äî</div>
        </div>
        <div style="text-align:right">
          <div class="small">‡¶°‡¶ø‡¶ó‡ßç‡¶∞‡¶ø</div>
          <div id="m-rashi-deg" class="m-sub">‚Äî</div>
        </div>
      </div>

      <!-- 3-part indicator (show which 1/3 of rashi) -->
      <div style="margin-top:8px">
        <div class="small">‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® (‡¶∞‡¶æ‡¶∂‡¶ø‡¶∞ ‡ß© ‡¶≠‡¶æ‡¶ó‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá)</div>
        <div class="progressWrap" style="margin-top:6px">
          <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:6px;color:#444">
            <div>‡¶™‡ßç‡¶∞‡¶•‡¶Æ</div><div>‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü</div><div>‡¶§‡ßÉ‡¶§‡ßÄ‡ßü</div>
          </div>
          <div style="background:#eee;border-radius:8px;padding:4px">
            <div id="m-rashi-seg" style="display:flex;gap:2px">
              <div style="flex:1;height:10px;border-radius:6px;background:#fff"></div>
              <div style="flex:1;height:10px;border-radius:6px;background:#fff"></div>
              <div style="flex:1;height:10px;border-radius:6px;background:#fff"></div>
            </div>
          </div>
        </div>
        <div style="margin-top:8px">
          <div class="small">‡¶ö‡¶æ‡¶Å‡¶¶‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶ó‡ßç‡¶∞‡ßá‡¶∏: <span id="m-moon-progress" style="font-weight:900">‚Äî</span></div>
          <div class="progressWrap" style="margin-top:6px"><div id="m-moon-progbar" class="progressBar" style="width:0%"></div></div>
        </div>
        <div class="small" style="margin-top:8px">‡¶Ö‡¶ß‡¶ø‡¶™‡¶§‡¶ø ‡¶®‡¶ï‡ßç‡¶∑‡¶§‡ßç‡¶∞: <span id="m-rashi-adhipati" style="font-weight:900">‚Äî</span></div>
      </div>
    </div>

    <!-- 6. Sunrise/Sunset + GPS -->
    <div class="m-section" id="m-sun-card">
      <div class="m-row">
        <div>
          <div class="m-label">‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡ßã‡¶¶‡¶Ø‡¶º</div>
          <div class="m-value" id="m-sunrise">‚Äî</div>
        </div>
        <div>
          <div class="m-label">‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡¶æ‡¶∏‡ßç‡¶§</div>
          <div class="m-value" id="m-sunset">‚Äî</div>
        </div>
      </div>
      <div class="small" style="margin-top:8px">‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶®: <span id="m-place" style="font-weight:900">‚Äî</span> <span id="m-location-badge2"></span></div>
    </div>

    <div class="footerSmall">Auto refresh: ‡¶™‡ßç‡¶∞‡¶§‡¶ø <span id="m-refresh-min">60</span> ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá ¬∑ ‡¶™‡¶û‡ßç‡¶ú‡¶ø‡¶ï‡¶æ: <span id="m-mode-foot">‡¶¶‡ßÉ‡¶ï (Govt)</span></div>
  </div>
</div>

<!-- PART B: Madhabam Widget logic (JS) -->
<script>
(async function(){

/* ========= CONFIG ========= */
const REFRESH_MINUTES = 60; // default 60 (change here if you want 180)
document.getElementById('m-refresh-min').textContent = REFRESH_MINUTES;

/* ===== helpers & astronomical functions (reused / adapted from your engine) ===== */
const D2R=Math.PI/180,R2D=180/Math.PI; const norm=x=>((x%360)+360)%360;
function JD(y,m,d,ut=0){ if(m<=2){y--;m+=12;} const A=Math.floor(y/100),B=2-A+Math.floor(A/4);
  return Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+d+B-1524.5+ut/24; }
function gmst(J){ const T=(J-2451545)/36525; return norm(280.46061837+360.98564736629*(J-2451545)+0.000387933*T*T - T*T*T/38710000); }
function obliq(T){ return 23.439291-0.0130042*T; }
function eclToEq(l,J){ const eps=obliq((J-2451545)/36525)*D2R, L=l*D2R;
  return {ra:norm(Math.atan2(Math.sin(L)*Math.cos(eps),Math.cos(L))*R2D)/15, dec:Math.asin(Math.sin(eps)*Math.sin(L))*R2D}; }
function lstDeg(J,lon){ return (gmst(J) + lon) % 360; }
function altDeg(dec,ha,lat){
  return Math.asin(Math.sin(lat*D2R)*Math.sin(dec*D2R)+Math.cos(lat*D2R)*Math.cos(dec*D2R)*Math.cos(ha*D2R))*R2D;
}
function fmt12(h){ if(h==null||isNaN(h)) return "‚Äî"; h=(h+24)%24; const ap=h>=12?"PM":"AM";
  let hh=Math.floor(h%12); if(hh===0) hh=12; const mm=String(Math.round((h%1)*60)).padStart(2,"0");
  return `${hh}:${mm} ${ap}`; }

/* ===== Sun & Moon longitudes (approx) ===== */
function sunLong(J){ const d=J-2451545; const M=norm(357.52911+0.98560028*d);
  return norm(280.46646+0.98564736*d + 1.9146*Math.sin(M*D2R)+0.02*Math.sin(2*M*D2R)); }
function moonLong(J){ const d=J-2451545;
  const Lm=norm(218.3165+13.176358*d), D=norm(297.8501921+12.19074912*d), Ms=norm(357.5291092+0.98560028*d), Mm=norm(134.9633964+13.06499295*d);
  return norm(Lm + 6.289*Math.sin(Mm*D2R) + 1.274*Math.sin((2*D-Mm)*D2R) + 0.658*Math.sin(2*D*D2R) - 0.186*Math.sin(Ms*D2R));
}

/* ===== Mode params (keep as before) ===== */
const MODE_KEY="madhabam_mode_v7";
let MODE = localStorage.getItem(MODE_KEY) || "drik"; // 'drik' or 'surya'
function setMode(m){ MODE = m; localStorage.setItem(MODE_KEY,m); document.getElementById('m-mode-foot').textContent = (m==='drik'?'‡¶¶‡ßÉ‡¶ï (Govt)':'‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§'); }

/* Ayanamsa */
function lahiriAyanamsaDynamic(J){ const T=(J-2451545.0)/36525; return 24.0 + (50.290966/3600)*T*100; }
const MODE_PARAMS = {
  surya:{ sun_h0:-0.833, moon_h0:+0.125, sun_corr_deg:+0.00, moon_corr_deg:+0.00, tithi_bias_deg:+0.00, ayan:(J)=>24.00 },
  drik:{  sun_h0:-0.833, moon_h0:+0.25,  sun_corr_deg:+0.28, moon_corr_deg:+3.50, tithi_bias_deg:+0.25, ayan:lahiriAyanamsaDynamic }
};
function correctedSunLong(J,engine){ return norm(sunLong(J)  + (MODE_PARAMS[engine]?.sun_corr_deg||0)); }
function correctedMoonLong(J,engine){ return norm(moonLong(J) + (MODE_PARAMS[engine]?.moon_corr_deg||0)); }
function longitudesAt(J,engine){ return {ls:correctedSunLong(J,engine), lm:correctedMoonLong(J,engine)}; }

/* ===== Tithi / Nakshatra / Bangabda (reuse) ===== */
const NAK=["‡¶Ö‡¶∂‡ßç‡¶¨‡¶ø‡¶®‡ßÄ","‡¶≠‡¶∞‡¶£‡ßÄ","‡¶ï‡ßÉ‡¶§‡ßç‡¶§‡¶ø‡¶ï‡¶æ","‡¶∞‡ßã‡¶π‡¶ø‡¶£‡ßÄ","‡¶Æ‡ßÉ‡¶ó‡¶∂‡¶ø‡¶∞‡¶æ","‡¶Ü‡¶¶‡ßç‡¶∞‡¶æ","‡¶™‡ßÅ‡¶®‡¶∞‡ßç‡¶¨‡¶∏‡ßÇ","‡¶™‡ßÅ‡¶∑‡ßç‡¶Ø‡¶æ","‡¶Ü‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶æ","‡¶Æ‡¶ò‡¶æ","‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶´‡¶æ‡¶≤‡ßç‡¶ó‡ßÅ‡¶®‡ßÄ","‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶´‡¶æ‡¶≤‡ßç‡¶ó‡ßÅ‡¶®‡ßÄ","‡¶π‡¶∏‡ßç‡¶§‡¶æ","‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡¶æ","‡¶∏‡ßç‡¶¨‡¶æ‡¶§‡ßÄ","‡¶¨‡¶ø‡¶∂‡¶æ‡¶ñ‡¶æ","‡¶Ö‡¶®‡ßÅ‡¶∞‡¶æ‡¶ß‡¶æ","‡¶ú‡ßç‡¶Ø‡ßá‡¶∑‡ßç‡¶†‡¶æ","‡¶Æ‡ßÇ‡¶≤‡¶æ","‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶æ‡¶∑‡¶æ‡ßù‡¶æ","‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶æ‡¶∑‡¶æ‡ßù‡¶æ","‡¶∂‡ßç‡¶∞‡¶¨‡¶£‡¶æ","‡¶ß‡¶®‡¶ø‡¶∑‡ßç‡¶†‡¶æ","‡¶∂‡¶§‡¶≠‡¶ø‡¶∑‡¶æ","‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶≠‡¶æ‡¶¶‡ßç‡¶∞‡¶™‡¶¶","‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶≠‡¶æ‡¶¶‡ßç‡¶∞‡¶™‡¶¶","‡¶∞‡ßá‡¶¨‡¶§‡ßÄ"];
function siderealMoonLong(J, engine){ const ay=(MODE_PARAMS[engine]?.ayan?.(J) ?? 24.0); return norm(correctedMoonLong(J, engine) - ay); }
function nakIdx(J, engine){ return Math.floor(siderealMoonLong(J, engine) / (360/27)) % 27; }
function tithiInfoAt(J,engine){
  const p=MODE_PARAMS[engine]||MODE_PARAMS.surya;
  const {ls,lm}=longitudesAt(J,engine);
  const diff=norm(lm - ls + (p.tithi_bias_deg||0));
  const num=Math.floor(diff/12)+1;
  const paksha=(num<=15)?"‡¶∂‡ßÅ‡¶ï‡ßç‡¶≤‡¶™‡¶ï‡ßç‡¶∑":"‡¶ï‡ßÉ‡¶∑‡ßç‡¶£‡¶™‡¶ï‡ßç‡¶∑";
  return {num,paksha,angle:diff};
}
function tithiName(n){
  const a=["‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶™‡¶¶","‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü‡¶æ","‡¶§‡ßÉ‡¶§‡ßÄ‡ßü‡¶æ","‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•‡ßÄ","‡¶™‡¶û‡ßç‡¶ö‡¶Æ‡ßÄ","‡¶∑‡¶∑‡ßç‡¶†‡ßÄ","‡¶∏‡¶™‡ßç‡¶§‡¶Æ‡ßÄ","‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ‡ßÄ","‡¶®‡¶¨‡¶Æ‡ßÄ","‡¶¶‡¶∂‡¶Æ‡ßÄ","‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ","‡¶¶‡ßç‡¶¨‡¶æ‡¶¶‡¶∂‡ßÄ","‡¶§‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶¶‡¶∂‡ßÄ","‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶¶‡¶∂‡ßÄ","‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶ø‡¶Æ‡¶æ","‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶™‡¶¶","‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü‡¶æ","‡¶§‡ßÉ‡¶§‡ßÄ‡ßü‡¶æ","‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•‡ßÄ","‡¶™‡¶û‡ßç‡¶ö‡¶Æ‡ßÄ","‡¶∑‡¶∑‡ßç‡¶†‡ßÄ","‡¶∏‡¶™‡ßç‡¶§‡¶Æ‡ßÄ","‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ‡ßÄ","‡¶®‡¶¨‡¶Æ‡ßÄ","‡¶¶‡¶∂‡¶Æ‡ßÄ","‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ","‡¶¶‡ßç‡¶¨‡¶æ‡¶¶‡¶∂‡ßÄ","‡¶§‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶¶‡¶∂‡ßÄ","‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶¶‡¶∂‡ßÄ","‡¶Ö‡¶Æ‡¶æ‡¶¨‡¶∏‡ßç‡¶Ø‡¶æ"];
  return a[(n-1)%30];
}
const B_MONTHS=["‡¶¨‡ßà‡¶∂‡¶æ‡¶ñ","‡¶ú‡ßç‡¶Ø‡ßà‡¶∑‡ßç‡¶†","‡¶Ü‡¶∑‡¶æ‡ßù","‡¶∂‡ßç‡¶∞‡¶æ‡¶¨‡¶£","‡¶≠‡¶æ‡¶¶‡ßç‡¶∞","‡¶Ü‡¶∂‡ßç‡¶¨‡¶ø‡¶®","‡¶ï‡¶æ‡¶∞‡ßç‡¶§‡¶ø‡¶ï","‡¶Ö‡¶ó‡ßç‡¶∞‡¶π‡¶æ‡ßü‡¶£","‡¶™‡ßå‡¶∑","‡¶Æ‡¶æ‡¶ò","‡¶´‡¶æ‡¶≤‡ßç‡¶ó‡ßÅ‡¶®","‡¶ö‡ßà‡¶§‡ßç‡¶∞"];
function bangabdaFromSun(J, localDate){
  const by = (localDate >= new Date(localDate.getFullYear(),3,14)) ? (localDate.getFullYear()-593) : (localDate.getFullYear()-594);
  const ay=(MODE_PARAMS[MODE].ayan(J));
  const lon=norm(sunLong(J)-ay); const sign=Math.floor(lon/30); const day=Math.floor(lon%30)+1;
  return {month:B_MONTHS[sign], day, year:by};
}

/* ===== Rise/Set approximations (sun) - for display only; moon rise we will approximate from lunarRiseSetUTC if available ===== */
/* We'll compute sunrise/sunset via iterative method (approx) */
function solarRiseSetUTC_raw(J0,lat,lon,h0){
  let rise=null,setv=null;
  for(let k=0;k<24;k++){
    const a=J0+k/24, b=J0+(k+1)/24;
    const La=eclToEq(sunLong(a),a), Lb=eclToEq(sunLong(b),b);
    const Ha=((lstDeg(a,lon)/15 - La.ra)*15 + 540)%360 - 180;
    const Hb=((lstDeg(b,lon)/15 - Lb.ra)*15 + 540)%360 - 180;
    const Aa=altDeg(La.dec,Ha,lat)-h0, Ab=altDeg(Lb.dec,Hb,lat)-h0;
    if(Aa<0 && Ab>0 && rise===null){ let lo=a,hi=b; for(let i=0;i<18;i++){ const m=(lo+hi)/2;
      const L=eclToEq(sunLong(m),m), H=((lstDeg(m,lon)/15 - L.ra)*15 + 540)%360 - 180;
      const A=altDeg(L.dec,H,lat)-h0; if(A<0) lo=m; else hi=m; } rise=((lo+hi)/2 - J0)*24; }
    if(Aa>0 && Ab<0 && setv===null){ let lo=a,hi=b; for(let i=0;i<18;i++){ const m=(lo+hi)/2;
      const L=eclToEq(sunLong(m),m), H=((lstDeg(m,lon)/15 - L.ra)*15 + 540)%360 - 180;
      const A=altDeg(L.dec,H,lat)-h0; if(A>0) lo=m; else hi=m; } setv=((lo+hi)/2 - J0)*24; }
  } return {riseUTC:rise,setUTC:setv};
}
function lunarRiseSetUTC_raw(J0,lat,lon,h0){
  let rise=null,setv=null;
  for(let k=0;k<48;k++){
    const a=J0+k/48, b=J0+(k+1)/48;
    const La=eclToEq(correctedMoonLong(a,"drik"),a);
    const Lb=eclToEq(correctedMoonLong(b,"drik"),b);
    const Ha=((lstDeg(a,lon)/15 - La.ra)*15 + 540)%360 - 180;
    const Hb=((lstDeg(b,lon)/15 - Lb.ra)*15 + 540)%360 - 180;
    const Aa=altDeg(La.dec,Ha,lat)-h0, Ab=altDeg(Lb.dec,Hb,lat)-h0;
    if(Aa<0 && Ab>0 && rise===null){ let lo=a,hi=b; for(let i=0;i<18;i++){ const m=(lo+hi)/2;
      const L=eclToEq(correctedMoonLong(m,"drik"),m), H=((lstDeg(m,lon)/15 - L.ra)*15 + 540)%360 - 180;
      const A=altDeg(L.dec,H,lat)-h0; if(A<0) lo=m; else hi=m; } rise=((lo+hi)/2 - J0)*24; }
    if(Aa>0 && Ab<0 && setv===null){ let lo=a,hi=b; for(let i=0;i<18;i++){ const m=(lo+hi)/2;
      const L=eclToEq(correctedMoonLong(m,"drik"),m), H=((lstDeg(m,lon)/15 - L.ra)*15 + 540)%360 - 180;
      const A=altDeg(L.dec,H,lat)-h0; if(A>0) lo=m; else hi=m; } setv=((lo+hi)/2 - J0)*24; }
  } return {riseUTC:rise,setUTC:setv};
}
function solarRiseSetUTC(J0,lat,lon,h0,mode){
  const raw=solarRiseSetUTC_raw(J0,lat,lon,h0);
  return {riseUTC: raw.riseUTC!=null ? raw.riseUTC : null,
          setUTC:  raw.setUTC !=null ? raw.setUTC  : null};
}
function lunarRiseSetUTC(J0,lat,lon,h0,mode){
  const raw=lunarRiseSetUTC_raw(J0,lat,lon,h0);
  return {riseUTC: raw.riseUTC!=null ? raw.riseUTC : null,
          setUTC:  raw.setUTC !=null ? raw.setUTC  : null};
}

/* ===== Location resolver: GPS -> IP -> fallback ===== */
function timeout(p,ms){ return Promise.race([p,new Promise(res=>setTimeout(()=>res(null),ms))]); }
async function reverseNom(lat,lon){ try{ const r=await timeout(fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=10`),3500); const j=r?await r.json():null; if(j?.address){ const a=j.address; const city=a.city||a.town||a.village||a.county||a.state||""; const country=a.country||""; return {place:city?`${city}, ${country}`:country,city:city||"Unknown"} } }catch{} return {place:"",city:""} }
async function reverseBDC(lat,lon){ try{ const r=await timeout(fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`),3500); const j=r?await r.json():null; if(j){ const city=j.city||j.locality||j.principalSubdivision||""; const country=j.countryName||""; return {place:city?`${city}, ${country}`:country,city:city||"Unknown"} } }catch{} return {place:"",city:""} }
async function getLocation(){
  if(navigator.geolocation){
    const got = await new Promise(res=>{
      navigator.geolocation.getCurrentPosition(async p=>{
        const lat=p.coords.latitude, lon=p.coords.longitude; let geo=await reverseNom(lat,lon); if(!geo.place) geo=await reverseBDC(lat,lon);
        res({lat,lon,tz:(-new Date().getTimezoneOffset()/60),place:geo.place||"GPS",city:geo.city||"GPS",label:'GPS'});
      }, ()=>res(null), {timeout:5000});
    });
    if(got) return got;
  }
  try{
    const r = await timeout(fetch("https://ipapi.co/json/"),3500); const j = r?await r.json():null;
    if(j?.latitude) { let geo=await reverseNom(j.latitude,j.longitude); if(!geo.place) geo=await reverseBDC(j.latitude,j.longitude);
      return {lat:j.latitude,lon:j.longitude,tz:(-new Date().getTimezoneOffset()/60),place:geo.place||(j.city?`${j.city}, ${j.country_name}`:""),city:geo.city||j.city||"IP",label:'IP'};
    }
  }catch{}
  return {lat:22.5726, lon:88.3639, tz:(-new Date().getTimezoneOffset()/60), place:"Kolkata, India", city:"Kolkata", label:'Fallback'};
}

/* ===== small util: toBnDigits (for Bengali numerals) ===== */
const toBnDigits = n => n.toString().replace(/\d/g, d => "‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ"[d]);

/* ===== main render function ===== */
async function renderAll(){
  try{
    // locate
    const loc = await getLocation();
    const lat = loc.lat, lon = loc.lon, tz = loc.tz || (-new Date().getTimezoneOffset()/60);
    const place = loc.place || loc.city || "Kolkata";
    const badge = loc.label==='GPS' ? '<span class="badgeOk">GPS</span>' : (loc.label==='IP' ? '<span class="small">IP</span>' : '<span class="badgeWarn">Fallback</span>');
    document.getElementById('m-place').textContent = place;
    document.getElementById('m-location-badge').innerHTML = badge;
    document.getElementById('m-location-badge2').innerHTML = badge;

    // date epoch
    const now = new Date();
    const Y=now.getFullYear(), M=now.getMonth()+1, D=now.getDate();
    const J0UTC = JD(Y,M,D,0);

    // sunrise boundary selection for "panchika day"
    const sParam = MODE_PARAMS[MODE];
    const sUTC0 = solarRiseSetUTC(J0UTC,lat,lon,sParam.sun_h0,MODE);
    const srLocalHour0 = (sUTC0.riseUTC!=null) ? (sUTC0.riseUTC + tz) : 6;
    const localHr = now.getHours() + now.getMinutes()/60 + now.getSeconds()/3600;
    const JdayUTC = (localHr < srLocalHour0) ? (J0UTC-1) : J0UTC;

    // evaluation epoch (after sunrise)
    const JEval = JdayUTC + ((srLocalHour0 - tz) + 0.5)/24;

    // panchika items
    const tNow = tithiInfoAt(JEval, MODE);
    const tNum = tNow.num;
    const tName = tithiName(tNum);
    // tithi end time (approx)
    const tEndUTC = (function(){
      let cur = tNum; let lo=JEval, hi=JEval+2;
      for(let i=0;i<30;i++){ const mid=(lo+hi)/2; const n=tithiInfoAt(mid,MODE).num; if(n!==cur) hi=mid; else lo=mid; }
      return hi;
    })();
    const tEndLocalHours = (tEndUTC - JdayUTC)*24 + tz;
    const tNext = tithiName((tNum%30)+1);

    const nIdx = nakIdx(JEval,MODE);
    const nName = NAK[nIdx];
    const nEndUTC = (function(){
      const cur = nIdx; let lo=JEval, hi=JEval+1.6;
      while(nakIdx(hi,MODE)===cur && (hi-JEval)<2.0) hi += 0.1;
      if(nakIdx(hi,MODE)===cur) hi = JEval + 2.0;
      for(let i=0;i<40;i++){ const mid=(lo+hi)/2; if(nakIdx(mid,MODE)!==cur) hi=mid; else lo=mid;}
      return hi;
    })();
    const nEndLocalHours = (nEndUTC - JdayUTC)*24 + tz;
    const nNext = NAK[(nIdx+1)%27];

    // sunrise/sunset
    const sEv = solarRiseSetUTC(JdayUTC,lat,lon,sParam.sun_h0,MODE);
    const srLocal = (sEv.riseUTC!=null)? fmt12(sEv.riseUTC + tz) : "‚Äî";
    const ssLocal = (sEv.setUTC !=null)? fmt12(sEv.setUTC + tz) : "‚Äî";

    // moon (rashi + deg + progress)
    const lm = siderealMoonLong(JEval, MODE); // 0-360 (sidereal)
    const rashiIndex = Math.floor(lm / 30) % 12;
    const rashiNames = ["‡¶Æ‡ßá‡¶∑","‡¶¨‡ßÉ‡¶∑","‡¶Æ‡¶ø‡¶•‡ßÅ‡¶®","‡¶ï‡¶∞‡ßç‡¶ï‡¶ü","‡¶∏‡¶ø‡¶Ç‡¶π","‡¶ï‡¶®‡ßç‡¶Ø‡¶æ","‡¶§‡ßÅ‡¶≤‡¶æ","‡¶¨‡ßÉ‡¶∂‡ßç‡¶ö‡¶ø‡¶ï","‡¶ß‡¶®‡ßÅ","‡¶Æ‡¶ï‡¶∞","‡¶ï‡ßÅ‡¶Æ‡ßç‡¶≠","‡¶Æ‡ßÄ‡¶®"];
    const rashi = rashiNames[rashiIndex];
    const degInRashi = lm % 30;
    const degDisplay = `${Math.floor(degInRashi)}¬∞ ${Math.round((degInRashi%1)*60)}'`;
    // progress across the rashi in percent (0-100)
    const moonProgressPct = Math.round((degInRashi/30)*100);
    // which third? 0..2
    const seg = Math.floor((degInRashi/30)*3);

    // determine adhipati (planet ruling the rashi) and corresponding nakshatra owner mapping
    const rashiAdhipatiMap = {
      "‡¶Æ‡ßá‡¶∑":"‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤","‡¶¨‡ßÉ‡¶∑":"‡¶∂‡¶®‡¶ø","‡¶Æ‡¶ø‡¶•‡ßÅ‡¶®":"‡¶¨‡ßÅ‡¶ß","‡¶ï‡¶∞‡ßç‡¶ï‡¶ü":"‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞","‡¶∏‡¶ø‡¶Ç‡¶π":"‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø","‡¶ï‡¶®‡ßç‡¶Ø‡¶æ":"‡¶¨‡ßÅ‡¶ß",
      "‡¶§‡ßÅ‡¶≤‡¶æ":"‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞","‡¶¨‡ßÉ‡¶∂‡ßç‡¶ö‡¶ø‡¶ï":"‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤","‡¶ß‡¶®‡ßÅ":"‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø","‡¶Æ‡¶ï‡¶∞":"‡¶∂‡¶®‡¶ø","‡¶ï‡ßÅ‡¶Æ‡ßç‡¶≠":"‡¶∂‡¶®‡¶ø","‡¶Æ‡ßÄ‡¶®":"‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø"
    };
    const adhipati = rashiAdhipatiMap[rashi] || "‚Äî";

    // lagna (ascendant) ‚Äî compute from local sidereal time
    // we compute sun longitude (sidereal) and local sidereal time for JEval to derive ascendant approx
    const ay = MODE_PARAMS[MODE].ayan(JEval);
    const sunL = norm(sunLong(JEval) - ay);
    // compute ecliptic longitude of ascendant: use gmst -> LST -> ascendant approx via formula
    // simplified ascendant estimation: we compute local sidereal time in degrees then map to zodiac sign
    const lst = lstDeg(JEval, lon); // degrees
    // Ascendant longitude approx = LST - epsilon? Approx: use lst as ecliptic longitude of midheaven? For UI we will approximate ascendant = lst - 90¬∞ (since ascendant ~ eastern horizon)
    const ascDeg = norm(lst - 90);
    const ascRashiIndex = Math.floor(ascDeg / 30) % 12;
    const ascRashi = rashiNames[ascRashiIndex];
    const ascDegIn = ascDeg % 30;
    const ascDegDisplay = `${Math.floor(ascDegIn)}¬∞ ${Math.round((ascDegIn%1)*60)}'`;

    // tithi/nakshatra end display formatting
    function displayEnd(localHours){
      if(isNaN(localHours) || localHours===null) return "‚Äî";
      // localHours is hours from midnight (0-24)
      const base = new Date(); base.setHours(0,0,0,0);
      const h = Math.floor(localHours);
      const m = Math.round((localHours%1)*60);
      base.setHours(h,m,0,0);
      const wk = ["‡¶∞‡¶¨‡¶ø‡¶¨‡¶æ‡¶∞","‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞","‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤‡¶¨‡¶æ‡¶∞","‡¶¨‡ßÅ‡¶ß‡¶¨‡¶æ‡¶∞","‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞","‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞","‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞"];
      const day = wk[base.getDay()];
      return `${day}, ${fmt12(localHours)}`;
    }

    // populate DOM
    document.getElementById('m-paksha-val').textContent = tNow.paksha;
    // paksha emoji: from full->new mapping (use moon emoji variations)
    const pakshaEmoji = (tNow.paksha === "‡¶∂‡ßÅ‡¶ï‡ßç‡¶≤‡¶™‡¶ï‡ßç‡¶∑") ? "üåï‚Üíüåë" : "üåë‚Üíüåï";
    document.getElementById('m-paksha-sub').textContent = pakshaEmoji;

    document.getElementById('m-tithi-val').textContent = tName;
    document.getElementById('m-tithi-end').textContent = displayEnd(tEndLocalHours);
    document.getElementById('m-tithi-next').textContent = tNext;

    document.getElementById('m-nak-val').textContent = nName;
    document.getElementById('m-nak-end').textContent = displayEnd(nEndLocalHours);
    document.getElementById('m-nak-next').textContent = nNext;

    document.getElementById('m-lagna-val').textContent = ascRashi;
    document.getElementById('m-lagna-deg').textContent = ascDegDisplay;
    // lagna end estimate: we can approximate when ascendant moves to next rashi: compute hours until ascDeg crosses next 30 boundary
    const ascNextBoundaryDeg = Math.floor(ascDeg/30)*30 + 30;
    const degreesToNext = (ascNextBoundaryDeg - ascDeg + 360) % 360;
    // sidereal speed of earth ~360¬∞/24h => 15¬∞/h (approx) => time = degrees / 15
    const hoursToNext = degreesToNext / 15;
    const lagnaEndLocal = (localHr + hoursToNext) % 24;
    document.getElementById('m-lagna-end').textContent = fmt12(lagnaEndLocal);

    document.getElementById('m-rashi-val').textContent = rashi;
    document.getElementById('m-rashi-deg').textContent = degDisplay;
    document.getElementById('m-rashi-adhipati').textContent = adhipati;
    document.getElementById('m-moon-progress').textContent = moonProgressPct + "%";
    document.getElementById('m-moon-progbar').style.width = Math.max(2, moonProgressPct) + "%";

    // fill 3-segment rashi segs highlight
    const segElems = document.querySelectorAll('#m-rashi-seg > div');
    segElems.forEach((el,i)=>{ el.style.background = (i===seg ? '#ffd54f' : '#eee'); });

    // sun times
    document.getElementById('m-sunrise').textContent = srLocal;
    document.getElementById('m-sunset').textContent = ssLocal;

    // update mode slider UI
    const slider = document.getElementById('m-slider');
    const left = document.getElementById('m-mode-left');
    const right = document.getElementById('m-mode-right');
    // set initial slider position based on MODE
    if(MODE === 'drik'){ slider.style.transform = "translateX(100%)"; } else { slider.style.transform = "translateX(0%)"; }
    // show which is active (subtle)
    left.style.opacity = MODE==='surya'? '0.9':'0.8';
    right.style.opacity = MODE==='drik'? '0.9':'0.8';
    document.getElementById('m-mode-foot').textContent = (MODE==='drik'?'‡¶¶‡ßÉ‡¶ï (Govt)':'‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§');

    // set local time display in small place (m-location-badge showed badge earlier)
    const localTimeStr = new Intl.DateTimeFormat('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true}).format(now);
    const lt = document.getElementById('m-location-badge');
    if(lt) { /* keep badge as is */ }

    // DONE
  }catch(err){
    console.error("Madhabam widget error:", err);
  }
}

/* ===== toggle behavior (placed here so DOM elements exist) ===== */
document.addEventListener('click', function(e){
  if(e.target && (e.target.id==='m-toggle' || e.target.closest('#m-toggle'))){
    const newMode = (MODE==='drik')? 'surya' : 'drik';
    setMode(newMode);
    // animate slider immediately for feedback
    const slider = document.getElementById('m-slider');
    if(newMode === 'drik'){ slider.style.transform = "translateX(100%)"; } else { slider.style.transform = "translateX(0%)"; }
    // re-render quickly
    setTimeout(()=>{ renderAll(); }, 220);
  }
});

/* ===== initial run + auto-refresh scheduling ===== */
await renderAll();

// auto refresh every REFRESH_MINUTES
setInterval(()=>{ renderAll(); }, REFRESH_MINUTES * 60 * 1000);

// Additionally schedule reload at tithi/nakshatra boundaries (best-effort not to duplicate):
// We also set a safety 3-hour reload if long-running
setInterval(()=>{ location.reload(); }, 1000*60*60*3);

})();
  </script>
