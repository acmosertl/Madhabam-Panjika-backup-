<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‡¶Æ‡¶æ‡¶ß‡¶¨‡¶Æ ‡¶™‡¶û‡ßç‡¶ú‡¶ø‡¶ï‡¶æ v7.3 Final LTS</title>
<style>
:root{
  --bg:#fff4e3; --panel:#fff1dd; --card:#fff8ee; --pink:#f6a9d6;
  --label:#4527a0; --ink:#2b237c; --accent:#1565c0; --gold:#ffe8a6; --goldink:#7a5200;
  --shadow:0 4px 12px rgba(0,0,0,.10);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);font-family:"Noto Sans Bengali",system-ui,sans-serif;color:#1a1a1a}
.wrap{max-width:480px;margin:auto;padding:0}
.panel{background:var(--panel);border-radius:14px;padding:6px}
.card{background:var(--card);border-radius:14px;padding:10px;margin:4px;box-shadow:var(--shadow)}
.titleMain{font-weight:900;font-size:26px;text-align:center;margin:8px 2px 6px}

/* üî∏ Updated Toggle ‚Äî under-slider indicator style */
.toggleWrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
  margin:0 4px 8px;
}
.toggleBar{
  position:relative;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:#f8eed0;
  border:1px solid #e6d9a0;
  border-radius:999px;
  padding:6px;
  width:100%;
  overflow:hidden;
}
.toggleBar .seg{
  flex:1;
  text-align:center;
  font-weight:800;
  font-size:13px;
  color:#6a5617;
  position:relative;
  z-index:2;
}
.knob{
  position:absolute;
  top:55%;
  left:3px;
  width:50%;
  height:70%;
  border-radius:999px;
  background:linear-gradient(180deg,#ffb46e,#ff7043);
  box-shadow:inset 0 0 4px rgba(0,0,0,.2), 0 1px 4px rgba(0,0,0,.25);
  transition:transform .3s ease;
  transform:translateY(-50%);
  opacity:0.45;
  z-index:1; /* ‡¶è‡¶ñ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶°‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
}
.knob.right{
  transform:translate(100%,-50%);
}
.toggleHint{
  font-size:12px;
  color:#6a5617;
  font-weight:700;
  text-align:center;
}
.modeFlag{
  font-size:12px;
  color:#7a5200;
  font-weight:800;
  margin-top:4px;
  text-align:center;
}
  
/* ‡¶õ‡ßã‡¶ü ‡¶Æ‡ßã‡¶° ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó (‡¶ü‡¶ó‡¶≤‡ßá‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá) */
.modeFlag{font-size:12px;color:#7a5200;font-weight:800;margin-top:4px;text-align:center}

/* ‡¶™‡¶û‡ßç‡¶ú‡¶ø‡¶ï‡¶æ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° */
.pill{background:var(--pink);border-radius:10px;padding:10px;margin:6px 0}
.label{color:var(--label);font-weight:900;font-size:14px;margin-bottom:2px}
.value{font-weight:900;font-size:27px;line-height:1.15}
.sub{font-size:13px;margin-top:6px}
.sub b{font-weight:900}
.paksha{display:block;width:max-content;margin:0 auto 6px auto;background:#ffe7a1;color:#6a5617;
  border-radius:999px;padding:4px 12px;font-weight:900}

.timeCol{display:flex;flex-direction:column;gap:6px;margin-top:6px}
.timeItem{background:var(--pink);border-radius:10px;padding:8px}
.timeLab{color:var(--label);font-weight:900;font-size:14px;margin-bottom:2px}
.timeVal{font-weight:900;font-size:24px;line-height:1.1}
.timeVal .ampm{font-size:20px;margin-left:2px}

.footer{font-size:12px;text-align:center;margin:6px 0 2px;opacity:.95}
.nextTag{color:var(--accent);font-weight:900}

/* Tide */
.tide{background:linear-gradient(180deg,#183a8a,#0b2257);color:#fff;border-radius:12px;padding:10px;margin:4px}
.thead{font-weight:900;text-align:center;margin-bottom:6px}
.tCol{display:flex;flex-direction:column;gap:6px}
.tc{background:rgba(255,255,255,.11);padding:8px;border-radius:10px}
.tLab{font-weight:800;margin-bottom:2px}
.tVal{font-weight:900;font-size:18px}
.tVal .ampm{font-size:16px}
.badge{display:inline-block;margin-left:6px;padding:2px 8px;border-radius:999px;background:#eee;color:#444;font-size:11px;font-weight:800}
.badge.warn{background:#ffe1e1;color:#b00020}
.badge.ok{background:#e0ffe7;color:#0a7a2a}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel" id="root">
    <div style="text-align:center;padding:22px 0;font-weight:700">üìç ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
  </div>
</div>
<!-- Part B (JS) ‡¶®‡¶ø‡¶ö‡ßá <script> ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßã -->
  <script>
/* ==== MƒÅdhabam Pa√±jikƒÅ Engine v7.3 ‚Äî JS (Paste after Part A) ==== */

/* Math helpers */
const D2R=Math.PI/180,R2D=180/Math.PI,norm=x=>((x%360)+360)%360;
function JD(y,m,d,ut=0){ if(m<=2){y--;m+=12;} const A=Math.floor(y/100),B=2-A+Math.floor(A/4);
  return Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+d+B-1524.5+ut/24; }
function gmst(J){ const T=(J-2451545)/36525; return norm(280.46061837 + 360.98564736629*(J-2451545)); }
function obliq(T){ return 23.439291 - 0.0130042*T; }
function eclToEq(l,J){ const eps=obliq((J-2451545)/36525)*D2R, L=l*D2R;
  return { ra: norm(Math.atan2(Math.sin(L)*Math.cos(eps), Math.cos(L))*R2D)/15, dec: Math.asin(Math.sin(eps)*Math.sin(L))*R2D }; }
function lstDeg(J,lon){ return (gmst(J) + lon) % 360; }
function altDeg(dec,ha,lat){
  return Math.asin(Math.sin(lat*D2R)*Math.sin(dec*D2R) + Math.cos(lat*D2R)*Math.cos(dec*D2R)*Math.cos(ha*D2R))*R2D;
}
function fmt12(h){ if(h==null||isNaN(h)) return "‚Äî"; h=(h+24)%24; const ap=h>=12?"PM":"AM";
  let hh=Math.floor(h%12); if(hh===0) hh=12; const mm=String(Math.round((h%1)*60)).padStart(2,"0");
  return `${hh}:${mm} <span class="ampm">${ap}</span>`; }
const DAYS_BN=["‡¶∞‡¶¨‡¶ø‡¶¨‡¶æ‡¶∞","‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞","‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤‡¶¨‡¶æ‡¶∞","‡¶¨‡ßÅ‡¶ß‡¶¨‡¶æ‡¶∞","‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞","‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞","‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞"];
function fmtDayTime(baseDate, localHour){
  const d=new Date(baseDate); const h=Math.floor(localHour); const m=Math.round((localHour%1)*60);
  d.setHours(0,0,0,0); d.setHours(d.getHours()+h, m, 0, 0);
  return `${DAYS_BN[d.getDay()]}, ${fmt12(localHour)}`;
}

/* Base longitudes */
function sunLong(J){ const d=J-2451545; const M=norm(357.52911+0.98560028*d);
  return norm(280.46646 + 0.98564736*d + 1.9146*Math.sin(M*D2R) + 0.02*Math.sin(2*M*D2R)); }
function moonLong(J){ const d=J-2451545;
  const Lm=norm(218.3165+13.176358*d), D=norm(297.8501921+12.19074912*d), Ms=norm(357.5291092+0.98560028*d), Mm=norm(134.9633964+13.06499295*d);
  return norm(Lm + 6.289*Math.sin(Mm*D2R) + 1.274*Math.sin((2*D-Mm)*D2R) + 0.658*Math.sin(2*D*D2R) - 0.186*Math.sin(Ms*D2R));
}

/* Mode & params */
const MODE_KEY="madhabam_mode_v7"; let MODE=localStorage.getItem(MODE_KEY)||"drik";
const setMode=m=>{ MODE=m; localStorage.setItem(MODE_KEY,m); };
function lahiriAyanamsaDynamic(J){ const T=(J-2451545.0)/36525; return 24.0 + (50.290966/3600)*T*100; }
const MODE_PARAMS={
  surya:{ sun_h0:-0.833, moon_h0:+0.125, sun_corr_deg:0, moon_corr_deg:0, tithi_bias_deg:0, ayan:(J)=>24.0 },
  drik:{  sun_h0:-0.833, moon_h0:+0.25, sun_corr_deg:+0.28, moon_corr_deg:+3.50, tithi_bias_deg:+0.25, ayan:lahiriAyanamsaDynamic }
};
function correctedSunLong(J,engine){ return norm(sunLong(J) + (MODE_PARAMS[engine]?.sun_corr_deg||0)); }
function correctedMoonLong(J,engine){ return norm(moonLong(J) + (MODE_PARAMS[engine]?.moon_corr_deg||0)); }
function longitudesAt(J,engine){ return { ls: correctedSunLong(J,engine), lm: correctedMoonLong(J,engine) }; }

/* Rise/Set raw (solar) */
function solarRiseSetUTC_raw(J0,lat,lon,h0){ let rise=null,setv=null;
  for(let k=0;k<24;k++){
    const a=J0+k/24, b=J0+(k+1)/24;
    const La=eclToEq(sunLong(a),a), Lb=eclToEq(sunLong(b),b);
    const Ha=((lstDeg(a,lon)/15 - La.ra)*15 + 540)%360 - 180;
    const Hb=((lstDeg(b,lon)/15 - Lb.ra)*15 + 540)%360 - 180;
    const Aa=altDeg(La.dec,Ha,lat)-h0, Ab=altDeg(Lb.dec,Hb,lat)-h0;
    if(Aa<0 && Ab>0 && rise===null){ let lo=a,hi=b; for(let i=0;i<20;i++){ const m=(lo+hi)/2;
        const L=eclToEq(sunLong(m),m), H=((lstDeg(m,lon)/15 - L.ra)*15 + 540)%360 - 180; const A=altDeg(L.dec,H,lat)-h0; if(A<0) lo=m; else hi=m; }
      rise=((lo+hi)/2 - J0)*24; }
    if(Aa>0 && Ab<0 && setv===null){ let lo=a,hi=b; for(let i=0;i<20;i++){ const m=(lo+hi)/2;
        const L=eclToEq(sunLong(m),m), H=((lstDeg(m,lon)/15 - L.ra)*15 + 540)%360 - 180; const A=altDeg(L.dec,H,lat)-h0; if(A>0) lo=m; else hi=m; }
      setv=((lo+hi)/2 - J0)*24; }
  } return { riseUTC: rise, setUTC: setv };
}

function lunarRiseSetUTC_raw(J0,lat,lon,h0,engine){
  let rise=null,setv=null;
  const steps = 192; // finer scan every 7.5 min
  for(let k=0;k<steps;k++){
    const a=J0+k/steps, b=J0+(k+1)/steps;
    const La=eclToEq(correctedMoonLong(a,engine),a), Lb=eclToEq(correctedMoonLong(b,engine),b);
    const Ha=((lstDeg(a,lon)/15 - La.ra)*15 + 540)%360 - 180;
    const Hb=((lstDeg(b,lon)/15 - Lb.ra)*15 + 540)%360 - 180;
    const Aa=altDeg(La.dec,Ha,lat)-h0, Ab=altDeg(Lb.dec,Hb,lat)-h0;
    if(Aa<0 && Ab>0 && !rise){let lo=a,hi=b;for(let i=0;i<25;i++){
      const m=(lo+hi)/2;const L=eclToEq(correctedMoonLong(m,engine),m);
      const H=((lstDeg(m,lon)/15-L.ra)*15+540)%360-180;
      const A=altDeg(L.dec,H,lat)-h0;if(A<0)lo=m;else hi=m;}
      rise=((lo+hi)/2-J0)*24;}
    if(Aa>0 && Ab<0 && !setv){let lo=a,hi=b;for(let i=0;i<25;i++){
      const m=(lo+hi)/2;const L=eclToEq(correctedMoonLong(m,engine),m);
      const H=((lstDeg(m,lon)/15-L.ra)*15+540)%360-180;
      const A=altDeg(L.dec,H,lat)-h0;if(A>0)lo=m;else hi=m;}
      setv=((lo+hi)/2-J0)*24;}
  }
  return {riseUTC:rise,setUTC:setv};
}

/* wrappers with fine offset tuning */
function riseSetFineOffset(lat,mode){
  const band = Math.abs(lat)<10 ? 0 : Math.abs(lat)<25 ? 0.5 : 1.0;
  const base = (mode==="drik")? +0.5 : 0;
  return base + band; // minutes
}
function solarRiseSetUTC(J0,lat,lon,h0,mode){
  const raw=solarRiseSetUTC_raw(J0,lat,lon,h0);
  const off = riseSetFineOffset(lat,mode)/60;
  return { riseUTC: raw.riseUTC!=null ? raw.riseUTC+off : null, setUTC: raw.setUTC!=null ? raw.setUTC+off : null };
}
function lunarRiseSetUTC(J0,lat,lon,h0,mode){
  const raw = lunarRiseSetUTC_raw(J0,lat,lon,h0,mode);
  const off = riseSetFineOffset(lat,mode)/60;
  return { riseUTC: raw.riseUTC!=null ? raw.ris
    
    eUTC+off : null, setUTC: raw.setUTC!=null ? raw.setUTC+off : null };
}

/* Tithi / Nakshatra */
const NAK=["‡¶Ö‡¶∂‡ßç‡¶¨‡¶ø‡¶®‡ßÄ","‡¶≠‡¶∞‡¶£‡ßÄ","‡¶ï‡ßÉ‡¶§‡ßç‡¶§‡¶ø‡¶ï‡¶æ","‡¶∞‡ßã‡¶π‡¶ø‡¶£‡ßÄ","‡¶Æ‡ßÉ‡¶ó‡¶∂‡¶ø‡¶∞‡¶æ","‡¶Ü‡¶¶‡ßç‡¶∞‡¶æ","‡¶™‡ßÅ‡¶®‡¶∞‡ßç‡¶¨‡¶∏‡ßÇ","‡¶™‡ßÅ‡¶∑‡ßç‡¶Ø‡¶æ","‡¶Ü‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶æ","‡¶Æ‡¶ò‡¶æ","‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶´‡¶æ‡¶≤‡ßç‡¶ó‡ßÅ‡¶®‡ßÄ","‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶´‡¶æ‡¶≤‡ßç‡¶ó‡ßÅ‡¶®‡ßÄ","‡¶π‡¶∏‡ßç‡¶§‡¶æ","‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡¶æ","‡¶∏‡ßç‡¶¨‡¶æ‡¶§‡ßÄ","‡¶¨‡¶ø‡¶∂‡¶æ‡¶ñ‡¶æ","‡¶Ö‡¶®‡ßÅ‡¶∞‡¶æ‡¶ß‡¶æ","‡¶ú‡ßç‡¶Ø‡ßá‡¶∑‡ßç‡¶†‡¶æ","‡¶Æ‡ßÇ‡¶≤‡¶æ","‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶æ‡¶∑‡¶æ‡ßù‡¶æ","‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶æ‡¶∑‡¶æ‡ßù‡¶æ","‡¶∂‡ßç‡¶∞‡¶¨‡¶£‡¶æ","‡¶ß‡¶®‡¶ø‡¶∑‡ßç‡¶†‡¶æ","‡¶∂‡¶§‡¶≠‡¶ø‡¶∑‡¶æ","‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶≠‡¶æ‡¶¶‡ßç‡¶∞‡¶™‡¶¶","‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶≠‡¶æ‡¶¶‡ßç‡¶∞‡¶™‡¶¶","‡¶∞‡ßá‡¶¨‡¶§‡ßÄ"];
function tithiName(n){
  const a=["‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶™‡¶¶","‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü‡¶æ","‡¶§‡ßÉ‡¶§‡ßÄ‡ßü‡¶æ","‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•‡ßÄ","‡¶™‡¶û‡ßç‡¶ö‡¶Æ‡ßÄ","‡¶∑‡¶∑‡ßç‡¶†‡ßÄ","‡¶∏‡¶™‡ßç‡¶§‡¶Æ‡ßÄ","‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ‡ßÄ","‡¶®‡¶¨‡¶Æ‡ßÄ","‡¶¶‡¶∂‡¶Æ‡ßÄ","‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ","‡¶¶‡ßç‡¶¨‡¶æ‡¶¶‡¶∂‡ßÄ","‡¶§‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶¶‡¶∂‡ßÄ","‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶¶‡¶∂‡ßÄ","‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶ø‡¶Æ‡¶æ","‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶™‡¶¶","‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü‡¶æ","‡¶§‡ßÉ‡¶§‡ßÄ‡ßü‡¶æ","‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•‡ßÄ","‡¶™‡¶û‡ßç‡¶ö‡¶Æ‡ßÄ","‡¶∑‡¶∑‡ßç‡¶†‡ßÄ","‡¶∏‡¶™‡ßç‡¶§‡¶Æ‡ßÄ","‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ‡ßÄ","‡¶®‡¶¨‡¶Æ‡ßÄ","‡¶¶‡¶∂‡¶Æ‡ßÄ","‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ","‡¶¶‡ßç‡¶¨‡¶æ‡¶¶‡¶∂‡ßÄ","‡¶§‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶¶‡¶∂‡ßÄ","‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶¶‡¶∂‡ßÄ","‡¶Ö‡¶Æ‡¶æ‡¶¨‡¶∏‡ßç‡¶Ø‡¶æ"];
  return a[(n-1)%30];
}
function siderealMoonLong(J, engine){ const ay=(MODE_PARAMS[engine]?.ayan?.(J) ?? 24.0); return norm(correctedMoonLong(J, engine) - ay); }
function nakIdx(J, engine){ return Math.floor(siderealMoonLong(J, engine) / 13.3333333333) % 27; }
function tithiInfoAt(J,engine){
  const p=MODE_PARAMS[engine]||MODE_PARAMS.surya; const {ls,lm}=longitudesAt(J,engine);
  const diff=norm(lm - ls + (p.tithi_bias_deg||0));
  const num=Math.floor(diff/12)+1; const paksha=(num<=15)?"‡¶∂‡ßÅ‡¶ï‡ßç‡¶≤‡¶™‡¶ï‡ßç‡¶∑":"‡¶ï‡ßÉ‡¶∑‡ßç‡¶£‡¶™‡¶ï‡ßç‡¶∑";
  return { num, paksha, angle: diff };
}
function tithiEndUTC(JstartUTC,engine){
  const cur=tithiInfoAt(JstartUTC,engine).num; let lo=JstartUTC, hi=JstartUTC+2;
  for(let i=0;i<30;i++){ const mid=(lo+hi)/2; const n=tithiInfoAt(mid,engine).num; if(n!==cur) hi=mid; else lo=mid; }
  return hi;
}
function nakEndUTC(JstartUTC,engine){
  const cur=nakIdx(JstartUTC,engine); let lo=JstartUTC, hi=JstartUTC+1.5;
  while(nakIdx(hi,engine)===cur && (hi - JstartUTC) < 2.0) hi += 0.1;
  for(let i=0;i<40;i++){ const mid=(lo+hi)/2; const idx=nakIdx(mid,engine); if(idx!==cur) hi=mid; else lo=mid; }
  return hi;
}

/* Bangabda via surya-rashi */
const B_MONTHS=["‡¶¨‡ßà‡¶∂‡¶æ‡¶ñ","‡¶ú‡ßç‡¶Ø‡ßà‡¶∑‡ßç‡¶†","‡¶Ü‡¶∑‡¶æ‡ßù","‡¶∂‡ßç‡¶∞‡¶æ‡¶¨‡¶£","‡¶≠‡¶æ‡¶¶‡ßç‡¶∞","‡¶Ü‡¶∂‡ßç‡¶¨‡¶ø‡¶®","‡¶ï‡¶æ‡¶∞‡ßç‡¶§‡¶ø‡¶ï","‡¶Ö‡¶ó‡ßç‡¶∞‡¶π‡¶æ‡ßü‡¶£","‡¶™‡ßå‡¶∑","‡¶Æ‡¶æ‡¶ò","‡¶´‡¶æ‡¶≤‡ßç‡¶ó‡ßÅ‡¶®","‡¶ö‡ßà‡¶§‡ßç‡¶∞"];
function bangabdaFromSun(J, localDate){
  const by = (localDate >= new Date(localDate.getFullYear(),3,14)) ? (localDate.getFullYear()-593) : (localDate.getFullYear()-594);
  const ay = (MODE_PARAMS[MODE].ayan(J));
  const lon = norm(sunLong(J) - ay);
  const sign = Math.floor(lon/30);
  const day = Math.floor(lon%30)+1;
  return { month: B_MONTHS[sign], day, year: by };
}

/* Location resolver (GPS -> IP -> fallback) */
const FALLBACK={ lat:22.5726, lon:88.3639, tz:(-new Date().getTimezoneOffset()/60), place:"Kolkata, India", city:"Kolkata", label:'Fallback' };
function timeout(p,ms){ return Promise.race([p, new Promise(res=>setTimeout(()=>res(null),ms))]); }
async function reverseNom(lat,lon){ try{ const r=await timeout(fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=10`),3500); const j=r?await r.json():null; if(j?.address){ const a=j.address; const city=a.city||a.town||a.village||a.county||a.state||""; const country=a.country||""; return { place: city?`${city}, ${country}`:country, city:city||"Unknown" } } }catch{} return {place:"",city:""} }
async function getLocation(){
  if(navigator.geolocation){
    const got = await new Promise(res=>{
      navigator.geolocation.getCurrentPosition(async p=>{
        const lat=p.coords.latitude, lon=p.coords.longitude; let geo=await reverseNom(lat,lon); if(!geo.place) geo=await timeout(fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`),3500).then(r=>r? r.json().then(j=>({place:(j.city?`${j.city}, ${j.countryName}`:""), city: j.city||"Unknown"})) : {place:"",city:""}).catch(()=>({place:"",city:""}));
        res({ lat, lon, tz:(-new Date().getTimezoneOffset()/60), place: geo.place||"GPS", city:geo.city||"GPS", label:'GPS' });
      }, ()=>res(null), { timeout:5000 });
    });
    if(got) return got;
  }
  try{
    const r = await timeout(fetch("https://ipapi.co/json/"),3500); const j = r?await r.json():null;
    if(j?.latitude){ let geo = await reverseNom(j.latitude,j.longitude); if(!geo.place) geo = { place: j.city?`${j.city}, ${j.country_name}`:"", city: j.city||"IP" }; return { lat:j.latitude, lon:j.longitude, tz:(-new Date().getTimezoneOffset()/60), place:geo.place, city:geo.city, label:'IP' }; }
  }catch{}
  return FALLBACK;
}

/* small tide approx */
function tideApprox(lon){ const h1=(5 + (lon/15))%24, h2=(h1+12.42)%24, l1=(h1+6.21)%24, l2=(h2+6.21)%24; return {h1,h2,l1,l2,source:"‡¶Ü‡¶®‡ßÅ‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï"} }

/* Hybrid moon-times: try external provider (if CORS allows) else engine */
async function getAccurateMoonTimes(lat,lon,dateStr,J0UTC,tz,engine){
  // try sunrise-sunset-like third-party first (no key preferred) ‚Äî fallback to engine
  try{
    // Using sunrise-sunset.io as optional ‚Äî may not have moon; try a provider that returns moon if available
    const r = await fetch(`https://api.sunrisesunset.io/json?lat=${lat}&lng=${lon}&date=${dateStr}&timezone=Asia/Kolkata`);
    if(r.ok){
      const j = await r.json();
      if(j && j.results && (j.results.moonrise || j.results.moonset)){
        // if values present, convert to display format (they may be in local TZ)
        const mr = j.results.moonrise ? new Date(j.results.moonrise).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true, timeZone:'Asia/Kolkata'}) : "‚Äî";
        const ms = j.results.moonset ? new Date(j.results.moonset).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true, timeZone:'Asia/Kolkata'}) : "‚Äî";
        return { moonrise: mr, moonset: ms, source: "Live" };
      }
    }
  }catch(e){ /* ignore, fallback below */ }

  // fallback: use engine calculation (improved)
  const mEv = lunarRiseSetUTC(J0UTC, lat, lon, MODE_PARAMS[engine].moon_h0, engine);
  const mr = (mEv.riseUTC!=null)? fmt12((mEv.riseUTC + tz)) : "‚Äî";
  const ms = (mEv.setUTC!=null)? fmt12((mEv.setUTC + tz)) : "‚Äî";
  return { moonrise: mr, moonset: ms, source: "Engine" };
}

/* ===== Render: main init ===== */
(async function init(){
  const loc = await getLocation(); const {lat,lon,tz,place,city,label} = loc;
  const now = new Date();
  const Y = now.getFullYear(), M = now.getMonth()+1, D = now.getDate();
  const J0UTC = JD(Y,M,D,0);

// ===== ‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡ßã‡¶¶‡¶Ø‡¶º ‡¶ì ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º‡¶® ‡¶∏‡¶Æ‡¶Ø‡¶º (JEval Fix) =====
  const sParam = MODE_PARAMS[MODE];
  const sUTC0 = solarRiseSetUTC(J0UTC, lat, lon, sParam.sun_h0, MODE);
  const srLocalHour0 = (sUTC0 && sUTC0.riseUTC != null) ? (sUTC0.riseUTC + tz) : 6;

  // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßÄ‡¶Ø‡¶º ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶ò‡¶®‡ßç‡¶ü‡¶æ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá
  const localHr = now.getHours() + now.getMinutes()/60 + now.getSeconds()/3600;

  // ‡¶ï‡ßã‡¶® ‡¶¶‡¶ø‡¶®‡¶ü‡¶æ ‡¶ö‡¶≤‡¶õ‡ßá (‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡ßã‡¶¶‡¶Ø‡¶º ‡¶Ü‡¶ó‡ßá ‡¶®‡¶æ‡¶ï‡¶ø ‡¶™‡¶∞‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡¶∞ ‡¶ï‡¶∞‡ßá)
  const JdayUTC = (localHr < srLocalHour0) ? (J0UTC - 1) : J0UTC;

  // ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶ú‡ßÅ‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶® ‡¶á‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ‡¶Ø‡¶º‡ßá‡¶∂‡¶® (‡¶∏‡¶†‡¶ø‡¶ï ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
  const fractionalDayUTC = (localHr - tz) / 24;
  const JEval = JdayUTC + fractionalDayUTC;
  
  // choose mode params
  const sParam = MODE_PARAMS[MODE];

  // compute sunrise/sunset (solar) using engine (should match earlier)
  const sEv = solarRiseSetUTC(J0UTC, lat, lon, sParam.sun_h0, MODE);
  const sr = (sEv.riseUTC!=null)? fmt12((sEv.riseUTC + tz)) : "‚Äî";
  const ss = (sEv.setUTC !=null)? fmt12((sEv.setUTC + tz)) : "‚Äî";

  // choose evaluation epoch (approx midday after sunrise)
  const srLocalHour0 = (sEv.riseUTC!=null)? (sEv.riseUTC + tz) : 6;
  const localHr = now.getHours() + now.getMinutes()/60;
  const JdayUTC = (localHr < srLocalHour0) ? (J0UTC - 1) : J0UTC;
  const JEval = JdayUTC + ((srLocalHour0 - tz) + 0.5)/24;

  // panchika: tithi, nakshatra + their end UTC
  const tNow = tithiInfoAt(JEval, MODE);
  const nIdx = nakIdx(JEval, MODE);
  const tEndUTC = tithiEndUTC(JEval, MODE);
  const nEndUTC = nakEndUTC(JEval, MODE);

  // lunar: try hybrid provider then engine fallback (improved)
  const dateStr = now.toISOString().split('T')[0];
  const moonTimes = await getAccurateMoonTimes(lat,lon,dateStr,JdayUTC,tz,MODE);
  const mr = moonTimes.moonrise;
  const ms = moonTimes.moonset;

  // local end times for display (convert UTC->local hours relative to JdayUTC)
  const tEndLocal = (tEndUTC - JdayUTC) * 24 + tz;
  const nEndLocal = (nEndUTC - JdayUTC) * 24 + tz;

  const bang = bangabdaFromSun(JEval, now);
  const tide = tideApprox(lon);
  const modeTextLeft="‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§", modeTextRight="‡¶¶‡ßÉ‡¶ï (Govt)";
  const modeFooter = (MODE==="drik")?"‡¶¶‡ßÉ‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶ó‡¶£‡¶®‡¶æ":"‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶ó‡¶£‡¶®‡¶æ";
  const tNext = tithiName((tNow.num%30)+1);
  const nNext = NAK[(nIdx+1)%27];

  const verifyBadge = label==='GPS' ? '<span class="badge ok">GPS</span>' : (label==='IP' ? '<span class="badge">IP</span>' : '<span class="badge warn">Fallback</span>');

  // render HTML (same structure as before)
  document.getElementById("root").innerHTML = `
    <section class="card">
      <div class="titleMain">‡¶™‡¶û‡ßç‡¶ú‡¶ø‡¶ï‡¶æ</div>

      <div class="toggleWrap">
        <div class="toggleBar" id="toggleBar">
          <div class="knob ${MODE==='drik'?'right':''}" id="knob"></div>
          <div class="seg">${modeTextLeft}</div>
          <div class="seg">${modeTextRight}</div>
        </div>
        <div class="toggleHint">‡¶™‡¶û‡ßç‡¶ú‡¶ø‡¶ï‡¶æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>
        <div class="modeFlag" id="modeFlag">${modeFooter}</div>
      </div>

      <div class="card" style="margin:4px">
        <div class="sub" style="text-align:center">‡¶Ü‡¶ú: ${bang.day} ${bang.month} ${bang.year} ‡¶¨‡¶ô‡ßç‡¶ó‡¶æ‡¶¨‡ßç‡¶¶</div>
        <div class="sub" style="text-align:center;font-weight:800">üìç ${place||city} ${verifyBadge}</div>
        <div class="sub" id="lt" style="text-align:center"></div>
      </div>

      <div class="pill">
        <span class="paksha">${tNow.paksha}</span>
        <div class="label">‡¶§‡¶ø‡¶•‡¶ø</div>
        <div class="value"> ${tithiName(tNow.num)} </div>
        <div class="sub"><b>‡¶∂‡ßá‡¶∑:</b> ${fmtDayTime(new Date(), tEndLocal)} ¬∑ <b>‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ:</b> <span class="nextTag">${tNext}</span></div>
      </div>

      <div class="pill">
        <div class="label">‡¶®‡¶ï‡ßç‡¶∑‡¶§‡ßç‡¶∞</div>
        <div class="value">${NAK[nIdx]}</div>
        <div class="sub" style="color:var(--ink);font-weight:800">‡¶Ö‡¶ß‡¶ø‡¶™‡¶§‡¶ø ‡¶ó‡ßç‡¶∞‡¶π: ${
          {"‡¶Ö‡¶∂‡ßç‡¶¨‡¶ø‡¶®‡ßÄ":"‡¶ï‡ßá‡¶§‡ßÅ (Ketu)","‡¶≠‡¶∞‡¶£‡ßÄ":"‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞ (Venus)","‡¶ï‡ßÉ‡¶§‡ßç‡¶§‡¶ø‡¶ï‡¶æ":"‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø (Sun)","‡¶∞‡ßã‡¶π‡¶ø‡¶£‡ßÄ":"‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞ (Moon)","‡¶Æ‡ßÉ‡¶ó‡¶∂‡¶ø‡¶∞‡¶æ":"‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤ (Mars)","‡¶Ü‡¶¶‡ßç‡¶∞‡¶æ":"‡¶∞‡¶æ‡¶π‡ßÅ (Rahu)","‡¶™‡ßÅ‡¶®‡¶∞‡ßç‡¶¨‡¶∏‡ßÇ":"‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø (Jupiter)","‡¶™‡ßÅ‡¶∑‡ßç‡¶Ø‡¶æ":"‡¶∂‡¶®‡¶ø (Saturn)","‡¶Ü‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶æ":"‡¶¨‡ßÅ‡¶ß (Mercury)","‡¶Æ‡¶ò‡¶æ":"‡¶ï‡ßá‡¶§‡ßÅ (Ketu)","‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶´‡¶æ‡¶≤‡ßç‡¶ó‡ßÅ‡¶®‡ßÄ":"‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞ (Venus)","‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶´‡¶æ‡¶≤‡ßç‡¶ó‡ßÅ‡¶®‡ßÄ":"‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø (Sun)","‡¶π‡¶∏‡ßç‡¶§‡¶æ":"‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞ (Moon)","‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡¶æ":"‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤ (Mars)","‡¶∏‡ßç‡¶¨‡¶æ‡¶§‡ßÄ":"‡¶∞‡¶æ‡¶π‡ßÅ (Rahu)","‡¶¨‡¶ø‡¶∂‡¶æ‡¶ñ‡¶æ":"‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø (Jupiter)","‡¶Ö‡¶®‡ßÅ‡¶∞‡¶æ‡¶ß‡¶æ":"‡¶∂‡¶®‡¶ø (Saturn)","‡¶ú‡ßç‡¶Ø‡ßá‡¶∑‡ßç‡¶†‡¶æ":"‡¶¨‡ßÅ‡¶ß (Mercury)","‡¶Æ‡ßÇ‡¶≤‡¶æ":"‡¶ï‡ßá‡¶§‡ßÅ (Ketu)","‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶æ‡¶∑‡¶æ‡ßù‡¶æ":"‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞ (Venus)","‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶æ‡¶∑‡¶æ‡ßù‡¶æ":"‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø (Sun)","‡¶∂‡ßç‡¶∞‡¶¨‡¶£‡¶æ":"‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞ (Moon)","‡¶ß‡¶®‡¶ø‡¶∑‡ßç‡¶†‡¶æ":"‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤ (Mars)","‡¶∂‡¶§‡¶≠‡¶ø‡¶∑‡¶æ":"‡¶∞‡¶æ‡¶π‡ßÅ (Rahu)","‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶≠‡¶æ‡¶¶‡ßç‡¶∞‡¶™‡¶¶":"‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø (Jupiter)","‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶≠‡¶æ‡¶¶‡ßç‡¶∞‡¶™‡¶¶":"‡¶∂‡¶®‡¶ø (Saturn)","‡¶∞‡ßá‡¶¨‡¶§‡ßÄ":"‡¶¨‡ßÅ‡¶ß (Mercury)"}[NAK[nIdx]]||"‚Äî"
        }</div>
        <div class="sub"><b>‡¶∂‡ßá‡¶∑:</b> ${fmtDayTime(new Date(), nEndLocal)} ¬∑ <b>‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ:</b> <span class="nextTag">${nNext}</span></div>
      </div>

      <div class="timeCol">
        <div class="timeItem"><div class="timeLab">‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡ßã‡¶¶‡¶Ø‡¶º</div><div class="timeVal">${sr}</div></div>
        <div class="timeItem"><div class="timeLab">‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡¶æ‡¶∏‡ßç‡¶§</div><div class="timeVal">${ss}</div></div>
        <div class="timeItem"><div class="timeLab">‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßã‡¶¶‡¶Ø‡¶º</div><div class="timeVal">${mr}</div></div>
        <div class="timeItem"><div class="timeLab">‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡ßç‡¶§</div><div class="timeVal">${ms}</div></div>
      </div>

      <div class="footer">Latitude ${lat.toFixed(2)}¬∞, Longitude ${lon.toFixed(2)}¬∞</div>
      <div class="footer">${modeFooter}</div>
    </section>

    <section class="tide">
      <div class="thead">üåä ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ú‡ßã‡¶Ø‡¶º‡¶æ‡¶∞-‡¶≠‡¶æ‡¶ü‡¶æ <span class="badge">${tide.source}</span></div>
      <div class="tCol">
        <div class="tc"><div class="tLab">‡¶â‡¶ö‡ßç‡¶ö ‡¶ú‡ßã‡¶Ø‡¶º‡¶æ‡¶∞ ‡ßß</div><div class="tVal">${fmt12(tide.h1)}</div></div>
        <div class="tc"><div class="tLab">‡¶â‡¶ö‡ßç‡¶ö ‡¶ú‡ßã‡¶Ø‡¶º‡¶æ‡¶∞ ‡ß®</div><div class="tVal">${fmt12(tide.h2)}</div></div>
        <div class="tc"><div class="tLab">‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶≠‡¶æ‡¶ü‡¶æ ‡ßß</div><div class="tVal">${fmt12(tide.l1)}</div></div>
        <div class="tc"><div class="tLab">‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶≠‡¶æ‡¶ü‡¶æ ‡ß®</div><div class="tVal">${fmt12(tide.l2)}</div></div>
      </div>
    </section>
  `;

  // live clock
  const tzFmt = new Intl.DateTimeFormat('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true,timeZoneName:'short'});
  document.getElementById('lt').textContent = "‚è∞ Local Time ‚Äî "+ tzFmt.format(now);

  // toggle behavior (same as before) + update small modeFlag
  const bar = document.getElementById('toggleBar'), knob = document.getElementById('knob'), mf = document.getElementById('modeFlag');
  bar.onclick = ()=>{ setMode(MODE==="drik"?"surya":"drik"); location.reload(); };
  if(mf) mf.textContent = (MODE==="drik") ? "‡¶¶‡ßÉ‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶ó‡¶£‡¶®‡¶æ" : "‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶ó‡¶£‡¶®‡¶æ";

  /* Auto-Refresh: ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ß© ‡¶ò‡¶£‡ßç‡¶ü‡¶æ + ‡¶§‡¶ø‡¶•‡¶ø/‡¶®‡¶ï‡ßç‡¶∑‡¶§‡ßç‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶Æ‡ßÅ‡¶π‡ßÇ‡¶∞‡ßç‡¶§‡ßá */
  setInterval(()=>location.reload(), 1000*60*60*3);
  const nowH = now.getHours() + now.getMinutes()/60 + now.getSeconds()/3600;
  const delayT = (( (tEndLocal || 999) - nowH + 24) % 24) * 3600 * 1000;
  const delayN = (( (nEndLocal || 999) - nowH + 24) % 24) * 3600 * 1000;
  const nextReload = Math.min(delayT || Infinity, delayN || Infinity);
  if(isFinite(nextReload) && nextReload>0 && nextReload < 1000*60*60*24) setTimeout(()=>location.reload(), nextReload);
})();
</script>
</body>
</html>
