<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ржорж╛ржзржмржо ржкржЮрзНржЬрж┐ржХрж╛ v7 тАФ Part A</title>
<style>
:root{
  --bg:#fff4e3; --panel:#fff1dd; --card:#fff8ee;
  --pink1:#ffd6e8; --pink2:#f7b0dc; --pink3:#f6a9d6; --pink4:#f0a2c9;
  --label:#4527a0; --ink:#2b237c; --accent:#1565c0; --gold:#ffe8a6;
  --muted:#8a7a6f;
  --shadow:0 6px 18px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);font-family:"Noto Sans Bengali",system-ui,sans-serif;color:var(--ink)}
.wrap{max-width:520px;margin:18px auto;padding:0}
.panel{background:var(--panel);border-radius:14px;padding:10px;box-shadow:var(--shadow)}
.card{background:var(--card);border-radius:12px;padding:12px;margin:10px 6px;box-shadow:0 4px 10px rgba(0,0,0,.04)}
.titleMain{font-weight:900;font-size:30px;text-align:center;margin:6px 2px 10px;color:var(--label)}

/* ===== Toggle (variant C: labels on top, slider knob below moving under labels) ===== */
.panjika-select{display:flex;flex-direction:column;align-items:center;gap:6px;margin:4px 6px}
.toggleLabels{display:flex;justify-content:space-between;width:100%;padding:4px 8px}
.toggleLabels .lab{flex:1;text-align:center;font-weight:800;color:var(--muted);font-size:14px}
.toggleTrack{position:relative;width:78%;height:36px;border-radius:999px;background:linear-gradient(90deg,#f9f3dd,#fff0c6);border:1px solid #edd8a8;display:flex;align-items:center;padding:4px;margin:0 auto}
.trackLabel{flex:1;text-align:center;font-weight:800;font-size:14px;color:var(--label);z-index:2}
.knob{position:absolute;top:4px;width:46%;height:28px;border-radius:999px;
  background:linear-gradient(90deg,#ffb3a5,#ff8f6f);box-shadow:0 6px 12px rgba(255,111,97,.18);
  transition:transform .28s cubic-bezier(.2,.9,.2,1);display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;z-index:3}
.knob.small{font-size:13px;padding-left:4px;padding-right:4px}
.knob.right{transform:translateX(calc(100% - 2%));}

/* Toggle hint */
.toggleHint{font-size:12px;color:#6a5617;font-weight:700;text-align:center;margin-top:4px}

/* Pill cards (pink variations) */
.pill{border-radius:12px;padding:12px;margin:8px 0;box-shadow:0 4px 8px rgba(0,0,0,.03)}
.pink-a{background:linear-gradient(180deg,var(--pink1),var(--pink2));}
.pink-b{background:linear-gradient(180deg,var(--pink2),var(--pink3));}
.pink-c{background:linear-gradient(180deg,var(--pink3),var(--pink4));}
.label{color:var(--label);font-weight:900;font-size:14px;margin-bottom:6px}
.value{font-weight:900;font-size:28px;line-height:1.1;color:var(--ink)}
.sub{font-size:13px;margin-top:8px;color:var(--muted)}
.sub b{font-weight:900}
.paksha{display:block;width:max-content;margin:0 auto 8px auto;background:#ffe7a1;color:#6a5617;border-radius:999px;padding:6px 14px;font-weight:900}

/* Time list */
.timeCol{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.timeItem{border-radius:10px;padding:12px;background:rgba(255,255,255,.5);font-weight:800}
.timeLab{color:var(--label);font-weight:900;font-size:13px;margin-bottom:6px}
.timeVal{font-weight:900;font-size:24px;line-height:1.1}
.timeVal .ampm{font-size:18px;margin-left:6px;color:var(--muted)}

/* Rashi / Lagna & progress bars */
.rashiCard{background:#fff;border-radius:10px;padding:12px;margin-top:10px;box-shadow:0 4px 8px rgba(0,0,0,.03)}
.progressWrap{background:#eee;border-radius:10px;padding:8px}
.progressBar{height:10px;border-radius:10px;background:#f5f5f5;overflow:hidden}
.progressFill{height:100%;width:0%;border-radius:10px;background:linear-gradient(90deg,#ffd76a,#ff8fa2)}
.progressLabel{display:flex;justify-content:space-between;margin-top:8px;font-weight:800;color:var(--label)}

/* footer small note */
.footer{font-size:12px;text-align:center;margin:8px 0;color:var(--muted)}

/* responsive tweaks */
@media (max-width:420px){
  .wrap{padding:0 8px}
  .titleMain{font-size:24px}
  .value{font-size:24px}
  .knob{height:26px}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel" id="root">
    <div style="text-align:center;padding:22px 0;font-weight:700;color:var(--label)">ЁЯУН ржЕржмрж╕рзНржерж╛ржи ржирж┐рж░рзНржзрж╛рж░ржг ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...</div>
  </div>
</div>

<script>
/* ===== Part A: helper functions + core engine pieces ===== */
/* Math & units */
const D2R = Math.PI/180, R2D = 180/Math.PI;
const norm = x => ((x%360)+360)%360;

/* Julian day */
function JD(y,m,d,ut=0){
  if(m<=2){ y--; m+=12; }
  const A=Math.floor(y/100), B=2-A+Math.floor(A/4);
  return Math.floor(365.25*(y+4716)) + Math.floor(30.6001*(m+1)) + d + B - 1524.5 + ut/24;
}

/* GMST */
function gmst(J){
  const T=(J-2451545)/36525;
  return norm(280.46061837 + 360.98564736629*(J-2451545) + 0.000387933*T*T - T*T*T/38710000);
}

/* obliquity (approx) */
function obliq(T){ return 23.439291 - 0.0130042*T; }

/* ecliptic to equatorial (returns RA in hours, dec in degrees) */
function eclToEq(l,J){
  const eps = obliq((J-2451545)/36525) * D2R;
  const L = l*D2R;
  const ra = Math.atan2(Math.sin(L)*Math.cos(eps), Math.cos(L)) * R2D;
  const dec = Math.asin(Math.sin(eps)*Math.sin(L)) * R2D;
  return { ra: norm(ra)/15, dec };
}

/* local sidereal deg */
function lstDeg(J, lon){ return (gmst(J) + lon) % 360; }

/* altitude from dec, hour angle, lat */
function altDeg(dec, ha, lat){
  return Math.asin(Math.sin(lat*D2R)*Math.sin(dec*D2R) + Math.cos(lat*D2R)*Math.cos(dec*D2R)*Math.cos(ha*D2R)) * R2D;
}

/* robust fmt12 тАФ handle rounding minutes==60 */
function fmt12(h){
  if(h==null || isNaN(h)) return "тАФ";
  h = (h + 24) % 24;
  let hh = Math.floor(h);
  let mm = Math.round((h - hh)*60);
  if(mm===60){ hh = (hh+1)%24; mm = 0; }
  const ap = hh>=12 ? "PM":"AM";
  let disp = hh%12; if(disp===0) disp = 12;
  return `${disp}:${String(mm).padStart(2,'0')} <span class="ampm">${ap}</span>`;
}

/* days bn */
const DAYS_BN=["рж░ржмрж┐ржмрж╛рж░","рж╕рзЛржоржмрж╛рж░","ржоржЩрзНржЧрж▓ржмрж╛рж░","ржмрзБржзржмрж╛рж░","ржмрзГрж╣рж╕рзНржкрждрж┐ржмрж╛рж░","рж╢рзБржХрзНрж░ржмрж╛рж░","рж╢ржирж┐ржмрж╛рж░"];
function fmtDayTime(baseDate, localHour){
  const d=new Date(baseDate);
  const h=Math.floor(localHour), m=Math.round((localHour%1)*60);
  d.setHours(0,0,0,0);
  d.setHours(d.getHours() + h, m, 0, 0);
  return `${DAYS_BN[d.getDay()]}, ${fmt12(localHour)}`;
}

/* Sun & Moon longitudes (approx) */
function sunLong(J){
  const d = J - 2451545;
  const M = norm(357.52911 + 0.98560028*d);
  return norm(280.46646 + 0.98564736*d + 1.9146*Math.sin(M*D2R) + 0.02*Math.sin(2*M*D2R));
}
function moonLong(J){
  const d = J - 2451545;
  const Lm = norm(218.3165 + 13.176358*d);
  const D = norm(297.8501921 + 12.19074912*d);
  const Ms = norm(357.5291092 + 0.98560028*d);
  const Mm = norm(134.9633964 + 13.06499295*d);
  return norm(Lm + 6.289*Math.sin(Mm*D2R) + 1.274*Math.sin((2*D - Mm)*D2R) + 0.658*Math.sin(2*D*D2R) - 0.186*Math.sin(Ms*D2R));
}

/* ===== Mode & calibration (drik/surya) ===== */
const MODE_KEY="madhabam_mode_v7";
let MODE=localStorage.getItem(MODE_KEY) || "drik";
const setMode = m => { MODE=m; localStorage.setItem(MODE_KEY,m); };

/* Lahiri-ish ayan dynamic (approx) */
function lahiriAyanamsaDynamic(J){
  const T=(J-2451545.0)/36525;
  return 24.0 + (50.290966/3600)*T*100;
}

const MODE_PARAMS = {
  surya: { sun_h0:-0.833, moon_h0:+0.125, sun_corr_deg:+0.00, moon_corr_deg:+0.00, tithi_bias_deg:+0.00, ayan: J => 24.00 },
  drik:  { sun_h0:-0.833, moon_h0:+0.25,  sun_corr_deg:+0.28, moon_corr_deg:+3.50, tithi_bias_deg:+0.25, ayan: lahiriAyanamsaDynamic }
};

/* rise/set minute fine tuning by lat-band */
function riseSetFineOffset(lat, mode){
  const band = Math.abs(lat) < 10 ? 0 : (Math.abs(lat) < 25 ? 0.5 : 1.0);
  const base = (mode==="drik") ? +0.5 : 0;
  return base + band; // minutes
}

/* corrected longitudes */
function correctedSunLong(J,engine){ return norm(sunLong(J) + (MODE_PARAMS[engine]?.sun_corr_deg || 0)); }
function correctedMoonLong(J,engine){ return norm(moonLong(J) + (MODE_PARAMS[engine]?.moon_corr_deg || 0)); }
function longitudesAt(J,engine){ return { ls: correctedSunLong(J,engine), lm: correctedMoonLong(J,engine) }; }

/* ===== Rise/Set raw calculators (solar & lunar) ===== */
/* Raw solar rise/set (search each hour) */
function solarRiseSetUTC_raw(J0, lat, lon, h0){
  let rise=null, setv=null;
  for(let k=0;k<24;k++){
    const a = J0 + k/24, b = J0 + (k+1)/24;
    const La = eclToEq(sunLong(a), a), Lb = eclToEq(sunLong(b), b);
    const Ha = ((lstDeg(a,lon)/15 - La.ra)*15 + 540)%360 - 180;
    const Hb = ((lstDeg(b,lon)/15 - Lb.ra)*15 + 540)%360 - 180;
    const Aa = altDeg(La.dec, Ha, lat) - h0, Ab = altDeg(Lb.dec, Hb, lat) - h0;
    if(Aa<0 && Ab>0 && rise===null){
      let lo=a, hi=b;
      for(let i=0;i<22;i++){
        const m=(lo+hi)/2;
        const L=eclToEq(sunLong(m), m);
        const H = ((lstDeg(m,lon)/15 - L.ra)*15 + 540)%360 - 180;
        const A = altDeg(L.dec, H, lat) - h0;
        if(A<0) lo = m; else hi = m;
      }
      rise = ((lo+hi)/2 - J0) * 24;
    }
    if(Aa>0 && Ab<0 && setv===null){
      let lo=a, hi=b;
      for(let i=0;i<22;i++){
        const m=(lo+hi)/2;
        const L=eclToEq(sunLong(m), m);
        const H = ((lstDeg(m,lon)/15 - L.ra)*15 + 540)%360 - 180;
        const A = altDeg(L.dec, H, lat) - h0;
        if(A>0) lo = m; else hi = m;
      }
      setv = ((lo+hi)/2 - J0) * 24;
    }
  }
  return { riseUTC: rise, setUTC: setv };
}

/* Raw lunar rise/set (uses 'engine' param properly) */
function lunarRiseSetUTC_raw(J0, lat, lon, h0, engine){
  let rise=null, setv=null;
  for(let k=0;k<48;k++){
    const a = J0 + k/48, b = J0 + (k+1)/48;
    const La = eclToEq(correctedMoonLong(a, engine), a);
    const Lb = eclToEq(correctedMoonLong(b, engine), b);
    const Ha = ((lstDeg(a,lon)/15 - La.ra)*15 + 540)%360 - 180;
    const Hb = ((lstDeg(b,lon)/15 - Lb.ra)*15 + 540)%360 - 180;
    const Aa = altDeg(La.dec, Ha, lat) - h0, Ab = altDeg(Lb.dec, Hb, lat) - h0;
    if(Aa<0 && Ab>0 && rise===null){
      let lo=a, hi=b;
      for(let i=0;i<22;i++){
        const m=(lo+hi)/2;
        const L = eclToEq(correctedMoonLong(m,engine), m);
        const H = ((lstDeg(m,lon)/15 - L.ra)*15 + 540)%360 - 180;
        const A = altDeg(L.dec, H, lat) - h0;
        if(A<0) lo = m; else hi = m;
      }
      rise = ((lo+hi)/2 - J0) * 24;
    }
    if(Aa>0 && Ab<0 && setv===null){
      let lo=a, hi=b;
      for(let i=0;i<22;i++){
        const m=(lo+hi)/2;
        const L = eclToEq(correctedMoonLong(m,engine), m);
        const H = ((lstDeg(m,lon)/15 - L.ra)*15 + 540)%360 - 180;
        const A = altDeg(L.dec, H, lat) - h0;
        if(A>0) lo = m; else hi = m;
      }
      setv = ((lo+hi)/2 - J0) * 24;
    }
  }
  return { riseUTC: rise, setUTC: setv };
}

/* calibrated wrappers */
function solarRiseSetUTC(J0, lat, lon, h0, mode){
  const raw = solarRiseSetUTC_raw(J0, lat, lon, h0);
  const off = riseSetFineOffset(lat, mode) / 60;
  return { riseUTC: raw.riseUTC != null ? raw.riseUTC + off : null, setUTC: raw.setUTC != null ? raw.setUTC + off : null };
}
function lunarRiseSetUTC(J0, lat, lon, h0, mode){
  const raw = lunarRiseSetUTC_raw(J0, lat, lon, h0, mode);
  const off = riseSetFineOffset(lat, mode) / 60;
  return { riseUTC: raw.riseUTC != null ? raw.riseUTC + off : null, setUTC: raw.setUTC != null ? raw.setUTC + off : null };
}

/* ===== Tithi / Nakshatra logic ===== */
function tithiName(n){
  const a=["ржкрзНрж░рждрж┐ржкржж","ржжрзНржмрж┐рждрзАрзЯрж╛","рждрзГрждрзАрзЯрж╛","ржЪрждрзБрж░рзНржерзА","ржкржЮрзНржЪржорзА","рж╖рж╖рзНржарзА","рж╕ржкрзНрждржорзА","ржЕрж╖рзНржЯржорзА","ржиржмржорзА","ржжрж╢ржорзА","ржПржХрж╛ржжрж╢рзА","ржжрзНржмрж╛ржжрж╢рзА","рждрзНрж░ржпрж╝рзЛржжрж╢рзА","ржЪрждрзБрж░рзНржжрж╢рзА","ржкрзВрж░рзНржгрж┐ржорж╛","ржкрзНрж░рждрж┐ржкржж","ржжрзНржмрж┐рждрзАрзЯрж╛","рждрзГрждрзАрзЯрж╛","ржЪрждрзБрж░рзНржерзА","ржкржЮрзНржЪржорзА","рж╖рж╖рзНржарзА","рж╕ржкрзНрждржорзА","ржЕрж╖рзНржЯржорзА","ржиржмржорзА","ржжрж╢ржорзА","ржПржХрж╛ржжрж╢рзА","ржжрзНржмрж╛ржжрж╢рзА","рждрзНрж░ржпрж╝рзЛржжрж╢рзА","ржЪрждрзБрж░рзНржжрж╢рзА","ржЕржорж╛ржмрж╕рзНржпрж╛"];
  return a[(n-1)%30];
}
const NAK=["ржЕрж╢рзНржмрж┐ржирзА","ржнрж░ржгрзА","ржХрзГрждрзНрждрж┐ржХрж╛","рж░рзЛрж╣рж┐ржгрзА","ржорзГржЧрж╢рж┐рж░рж╛","ржЖржжрзНрж░рж╛","ржкрзБржирж░рзНржмрж╕рзВ","ржкрзБрж╖рзНржпрж╛","ржЖрж╢рзНрж▓рзЗрж╖рж╛","ржоржШрж╛","ржкрзВрж░рзНржмржлрж╛рж▓рзНржЧрзБржирзА","ржЙрждрзНрждрж░ржлрж╛рж▓рзНржЧрзБржирзА","рж╣рж╕рзНрждрж╛","ржЪрж┐рждрзНрж░рж╛","рж╕рзНржмрж╛рждрзА","ржмрж┐рж╢рж╛ржЦрж╛","ржЕржирзБрж░рж╛ржзрж╛","ржЬрзНржпрзЗрж╖рзНржарж╛","ржорзВрж▓рж╛","ржкрзВрж░рзНржмрж╛рж╖рж╛рзЭрж╛","ржЙрждрзНрждрж░рж╛рж╖рж╛реЭрж╛","рж╢рзНрж░ржмржгрж╛","ржзржирж┐рж╖рзНржарж╛","рж╢рждржнрж┐рж╖рж╛","ржкрзВрж░рзНржмржнрж╛ржжрзНрж░ржкржж","ржЙрждрзНрждрж░ржнрж╛ржжрзНрж░ржкржж","рж░рзЗржмрждрзА"];

function siderealMoonLong(J, engine){ const ay=(MODE_PARAMS[engine]?.ayan?.(J) ?? 24.0); return norm(correctedMoonLong(J, engine) - ay); }
function nakIdx(J, engine){ return Math.floor(siderealMoonLong(J, engine) / (360/27)) % 27; }

function nakEndUTC(JstartUTC, engine){
  const cur = nakIdx(JstartUTC, engine);
  let lo = JstartUTC, hi = JstartUTC + 1.2;
  while (nakIdx(hi, engine) === cur && (hi - JstartUTC) < 2.0) hi += 0.1;
  if (nakIdx(hi, engine) === cur) hi = JstartUTC + 2.0;
  for(let i=0;i<40;i++){
    const mid=(lo+hi)/2;
    const idx = nakIdx(mid, engine);
    if(idx!==cur) hi = mid; else lo = mid;
  }
  return hi;
}

function tithiInfoAt(J, engine){
  const p = MODE_PARAMS[engine] || MODE_PARAMS.surya;
  const { ls, lm } = longitudesAt(J, engine);
  const diff = norm(lm - ls + (p.tithi_bias_deg||0));
  const num = Math.floor(diff/12) + 1;
  const paksha = (num <= 15) ? "рж╢рзБржХрзНрж▓ржкржХрзНрж╖" : "ржХрзГрж╖рзНржгржкржХрзНрж╖";
  return { num, paksha, angle: diff };
}

function tithiEndUTC(JstartUTC, engine){
  const cur = tithiInfoAt(JstartUTC, engine).num;
  let lo = JstartUTC, hi = JstartUTC + 2;
  for(let i=0;i<40;i++){
    const mid=(lo+hi)/2;
    const n = tithiInfoAt(mid, engine).num;
    if(n !== cur) hi = mid; else lo = mid;
  }
  return hi;
}

/* ===== Bangabda month from sun (Surya-siddhanta style / sankranti by sign) ===== */
const B_MONTHS=["ржмрзИрж╢рж╛ржЦ","ржЬрзНржпрзИрж╖рзНржа","ржЖрж╖рж╛рзЭ","рж╢рзНрж░рж╛ржмржг","ржнрж╛ржжрзНрж░","ржЖрж╢рзНржмрж┐ржи","ржХрж╛рж░рзНрждрж┐ржХ","ржЕржЧрзНрж░рж╣рж╛рзЯржг","ржкрзМрж╖","ржорж╛ржШ","ржлрж╛рж▓рзНржЧрзБржи","ржЪрзИрждрзНрж░"];
function bangabdaFromSun(J, localDate){
  const by = (localDate >= new Date(localDate.getFullYear(),3,14)) ? (localDate.getFullYear()-593) : (localDate.getFullYear()-594);
  const ay = (MODE_PARAMS[MODE].ayan(J));
  const lon = norm(sunLong(J) - ay);
  const sign = Math.floor(lon/30);
  const day = Math.floor(lon % 30) + 1;
  return { month: B_MONTHS[sign], day, year: by };
}

/* ===== Location resolver (GPS -> IP -> fallback) ===== */
const FALLBACK = { lat:22.5726, lon:88.3639, tz:(-new Date().getTimezoneOffset()/60), place:"Kolkata, India", city:"Kolkata", label:'Fallback' };
function timeout(p, ms){ return Promise.race([p, new Promise(res => setTimeout(()=>res(null), ms))]); }

async function reverseNom(lat, lon){
  try {
    const r = await timeout(fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=10`), 3500);
    const j = r ? await r.json() : null;
    if(j?.address){
      const a=j.address;
      const city = a.city || a.town || a.village || a.county || a.state || "";
      const country = a.country || "";
      return { place: city? `${city}, ${country}` : country, city: city || "Unknown" };
    }
  } catch(e){}
  return { place:"", city:"" };
}

async function reverseBDC(lat, lon){
  try {
    const r = await timeout(fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`),3500);
    const j = r ? await r.json() : null;
    if(j){
      const city = j.city || j.locality || j.principalSubdivision || "";
      const country = j.countryName || "";
      return { place: city? `${city}, ${country}` : country, city: city || "Unknown" };
    }
  } catch(e){}
  return { place:"", city:"" };
}

async function getLocation(){
  // try gps
  if(navigator.geolocation){
    const got = await new Promise(res=>{
      navigator.geolocation.getCurrentPosition(async p=>{
        const lat = p.coords.latitude, lon = p.coords.longitude;
        let geo = await reverseNom(lat, lon);
        if(!geo.place) geo = await reverseBDC(lat, lon);
        res({ lat, lon, tz:(-new Date().getTimezoneOffset()/60), place: geo.place || "GPS", city: geo.city || "GPS", label: 'GPS' });
      }, ()=>res(null), { timeout:5000 });
    });
    if(got) return got;
  }
  // try ip
  try{
    const r = await timeout(fetch("https://ipapi.co/json/"), 3500);
    const j = r ? await r.json() : null;
    if(j?.latitude){
      let geo = await reverseNom(j.latitude, j.longitude);
      if(!geo.place) geo = await reverseBDC(j.latitude, j.longitude);
      return { lat: j.latitude, lon: j.longitude, tz:(-new Date().getTimezoneOffset()/60), place: geo.place || (j.city? `${j.city}, ${j.country_name}` : ""), city: geo.city || j.city || "IP", label:'IP' };
    }
  }catch(e){}
  // fallback
  return FALLBACK;
}

/* simple tide approx (approximation fallback only) */
function tideApprox(lon){
  const h1 = (5 + (lon/15)) % 24;
  const h2 = (h1 + 12.42) % 24;
  const l1 = (h1 + 6.21) % 24;
  const l2 = (h2 + 6.21) % 24;
  return { h1, h2, l1, l2, source: "ржЖржирзБржорж╛ржирж┐ржХ" };
}

/* ===== Small UI helpers ===== */
function pakshaEmoji(p){
  // рж╢рзБржжрзНржз: рж╢рзБржХрзНрж▓ржкржХрзНрж╖ = new->full (waxing) => use ЁЯМТ (waxing), ржХрзГрж╖рзНржгржкржХрзНрж╖ = waning (ЁЯМШ)
  if(p === "рж╢рзБржХрзНрж▓ржкржХрзНрж╖") return "ЁЯМТ";
  if(p === "ржХрзГрж╖рзНржгржкржХрзНрж╖") return "ЁЯМШ";
  return "ЁЯМЧ";
}

/* ready тАФ Part A ends here. Next paste Part B which contains render/init and glue */
</script>

  <script>
/* ===== Part B: render, init and glue ===== */

(async function init(){
  try{
    const loc = await getLocation();
    const { lat, lon, tz, place, city, label } = loc;
    const now = new Date();
    const Y = now.getFullYear(), M = now.getMonth()+1, D = now.getDate();
    const J0UTC = JD(Y, M, D, 0);

    // sunrise boundary (local)
    const sParam = MODE_PARAMS[MODE];
    const sUTC0 = solarRiseSetUTC(J0UTC, lat, lon, sParam.sun_h0, MODE);
    const srLocalHour0 = (sUTC0.riseUTC != null) ? (sUTC0.riseUTC + tz) : 6;
    const localHr = now.getHours() + now.getMinutes()/60;
    const JdayUTC = (localHr < srLocalHour0) ? (J0UTC - 1) : J0UTC;

    // evaluation epoch a bit after sunrise boundary
    const JEval = JdayUTC + ((srLocalHour0 - tz) + 0.5) / 24;

    // Panchika data
    const tNow = tithiInfoAt(JEval, MODE);
    const nIdx = nakIdx(JEval, MODE);
    const tEndUTC = tithiEndUTC(JEval, MODE);
    const nEndUTC = nakEndUTC(JEval, MODE);

    const sEv = solarRiseSetUTC(JdayUTC, lat, lon, sParam.sun_h0, MODE);
    const mEv = lunarRiseSetUTC(JdayUTC, lat, lon, sParam.moon_h0, MODE);

    const sr = (sEv.riseUTC != null) ? fmt12((sEv.riseUTC + tz)) : "тАФ";
    const ss = (sEv.setUTC  != null) ? fmt12((sEv.setUTC  + tz)) : "тАФ";
    const mr = (mEv.riseUTC != null) ? fmt12((mEv.riseUTC + tz)) : "тАФ";
    const ms = (mEv.setUTC  != null) ? fmt12((mEv.setUTC + tz)) : "тАФ";

    const tEndLocal = (tEndUTC - JdayUTC)*24 + tz;
    const nEndLocal = (nEndUTC - JdayUTC)*24 + tz;

    const bang = bangabdaFromSun(JEval, now);
    const tide = tideApprox(lon);
    const modeTextLeft = "рж╕рзВрж░рзНржпрж╕рж┐ржжрзНржзрж╛ржирзНржд";
    const modeTextRight = "ржжрзГржХ (Govt)";
    const tNext = tithiName((tNow.num % 30) + 1);
    const nNext = NAK[(nIdx+1)%27];

    const verifyBadge = label==='GPS' ? '<span style="color:#0a7a2a;font-weight:800">GPS</span>' : (label==='IP' ? '<span style="color:#6a5617;font-weight:800">IP</span>' : '<span style="color:#b00020;font-weight:800">Fallback</span>');

    /* build HTML (keeps UI same as before, pink variations) */
    document.getElementById("root").innerHTML = `
      <section class="card">
        <div class="titleMain">ржЖржЬржХрзЗрж░ ржкржЮрзНржЬрж┐ржХрж╛</div>

        <div class="panjika-select">
          <div class="toggleLabels">
            <div class="lab">${modeTextLeft}</div>
            <div class="lab">${modeTextRight}</div>
          </div>

          <div class="toggleTrack" id="toggleTrack">
            <div class="trackLabel" style="text-align:left;padding-left:8px">рж╕рзВрж░рзНржпрж╕рж┐ржжрзНржзрж╛ржирзНржд</div>
            <div class="trackLabel" style="text-align:right;padding-right:8px">ржжрзГржХ (Govt)</div>
            <div class="knob ${MODE==='drik'?'right':''} small" id="knob">${MODE==='drik' ? 'ржжрзГржХ' : 'рж╕рзВрж░рзНржп'}</div>
          </div>
          <div class="toggleHint">ржЯржЧрж▓ ржХрж░рзЗ ржкржЮрзНржЬрж┐ржХрж╛ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзБржи</div>
        </div>

        <div class="card" style="margin:8px">
          <div class="sub" style="text-align:center;font-weight:800">ржЖржЬ: ${bang.day} ${bang.month} ${bang.year} ржмржЩрзНржЧрж╛ржмрзНржж</div>
          <div class="sub" style="text-align:center;font-weight:900">ЁЯУН ${place || city} ┬╖ ${verifyBadge}</div>
          <div class="sub" id="lt" style="text-align:center;margin-top:6px"></div>
        </div>

        <div class="pill pink-b">
          <span class="paksha">${pakshaEmoji(tNow.paksha)}  ${tNow.paksha}</span>
          <div class="label">рждрж┐ржерж┐</div>
          <div class="value">${tithiName(tNow.num)}</div>
          <div class="sub"><b>рж╢рзЗрж╖:</b> ${fmtDayTime(new Date(), tEndLocal)} ┬╖ <b>ржкрж░ржмрж░рзНрждрзА:</b> <span style="color:#0b63c4;font-weight:900">${tNext}</span></div>
        </div>

        <div class="pill pink-c">
          <div class="label">ржиржХрзНрж╖рждрзНрж░</div>
          <div class="value">${NAK[nIdx]}</div>
          <div class="sub" style="color:var(--ink);font-weight:800">ржЕржзрж┐ржкрждрж┐ ржЧрзНрж░рж╣: ${
            {"ржЕрж╢рзНржмрж┐ржирзА":"ржХрзЗрждрзБ (Ketu)","ржнрж░ржгрзА":"рж╢рзБржХрзНрж░ (Venus)","ржХрзГрждрзНрждрж┐ржХрж╛":"рж╕рзВрж░рзНржп (Sun)","рж░рзЛрж╣рж┐ржгрзА":"ржЪржирзНржжрзНрж░ (Moon)","ржорзГржЧрж╢рж┐рж░рж╛":"ржоржЩрзНржЧрж▓ (Mars)","ржЖржжрзНрж░рж╛":"рж░рж╛рж╣рзБ (Rahu)","ржкрзБржирж░рзНржмрж╕рзВ":"ржмрзГрж╣рж╕рзНржкрждрж┐ (Jupiter)","ржкрзБрж╖рзНржпрж╛":"рж╢ржирж┐ (Saturn)","ржЖрж╢рзНрж▓рзЗрж╖рж╛":"ржмрзБржз (Mercury)","ржоржШрж╛":"ржХрзЗрждрзБ (Ketu)","ржкрзВрж░рзНржмржлрж╛рж▓рзНржЧрзБржирзА":"рж╢рзБржХрзНрж░ (Venus)","ржЙрждрзНрждрж░ржлрж╛рж▓рзНржЧрзБржирзА":"рж╕рзВрж░рзНржп (Sun)","рж╣рж╕рзНрждрж╛":"ржЪржирзНржжрзНрж░ (Moon)","ржЪрж┐рждрзНрж░рж╛":"ржоржЩрзНржЧрж▓ (Mars)","рж╕рзНржмрж╛рждрзА":"рж░рж╛рж╣рзБ (Rahu)","ржмрж┐рж╢рж╛ржЦрж╛":"ржмрзГрж╣рж╕рзНржкрждрж┐ (Jupiter)","ржЕржирзБрж░рж╛ржзрж╛":"рж╢ржирж┐ (Saturn)","ржЬрзНржпрзЗрж╖рзНржарж╛":"ржмрзБржз (Mercury)","ржорзВрж▓рж╛":"ржХрзЗрждрзБ (Ketu)","ржкрзВрж░рзНржмрж╛рж╖рж╛рзЭрж╛":"рж╢рзБржХрзНрж░ (Venus)","ржЙрждрзНрждрж░рж╛рж╖рж╛рзЭрж╛":"рж╕рзВрж░рзНржп (Sun)","рж╢рзНрж░ржмржгрж╛":"ржЪржирзНржжрзНрж░ (Moon)","ржзржирж┐рж╖рзНржарж╛":"ржоржЩрзНржЧрж▓ (Mars)","рж╢рждржнрж┐рж╖рж╛":"рж░рж╛рж╣рзБ (Rahu)","ржкрзВрж░рзНржмржнрж╛ржжрзНрж░ржкржж":"ржмрзГрж╣рж╕рзНржкрждрж┐ (Jupiter)","ржЙрждрзНрждрж░ржнрж╛ржжрзНрж░ржкржж":"рж╢ржирж┐ (Saturn)","рж░рзЗржмрждрзА":"ржмрзБржз (Mercury)"}[NAK[nIdx]] || "тАФ"
          }</div>
          <div class="sub"><b>рж╢рзЗрж╖:</b> ${fmtDayTime(new Date(), nEndLocal)} ┬╖ <b>ржкрж░ржмрж░рзНрждрзА:</b> <span style="color:#0b63c4;font-weight:900">${nNext}</span></div>
        </div>

        <div class="pill pink-a">
          <div class="label">рж▓ржЧрзНржи</div>
          <div class="value">тАФ</div>
          <div class="sub">(рж▓ржЧрзНржи: рж╕рзВрж░рзНржпрзЗрж░ рж░рж╛рж╢рж┐ ржнрж┐рждрзНрждрж┐ржХ рж▓ржЧрзНржи рждржерзНржп ржирж┐ржЪрзЗ ржпрзЛржЧ ржХрж░рж╛ ржерж╛ржХржмрзЗ)</div>
        </div>

        <div class="pill pink-c" style="padding-bottom:6px">
          <div class="timeCol">
            <div class="timeItem"><div class="timeLab">рж╕рзВрж░рзНржпрзЛржжржпрж╝</div><div class="timeVal">${sr}</div></div>
            <div class="timeItem"><div class="timeLab">рж╕рзВрж░рзНржпрж╛рж╕рзНржд</div><div class="timeVal">${ss}</div></div>
            <div class="timeItem"><div class="timeLab">ржЪржирзНржжрзНрж░рзЛржжржпрж╝</div><div class="timeVal">${mr}</div></div>
            <div class="timeItem"><div class="timeLab">ржЪржирзНржжрзНрж░рж╛рж╕рзНржд</div><div class="timeVal">${ms}</div></div>
          </div>
        </div>

        <div class="rashiCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:900;color:var(--label)">рж░рж╛рж╢рж┐ (ржЪрж╛ржБржж)</div>
            <div style="font-weight:800;color:var(--muted)">ржЕржзрж┐ржкрждрж┐ ржиржХрзНрж╖рждрзНрж░: ${
              {"ржЕрж╢рзНржмрж┐ржирзА":"ржХрзЗрждрзБ","ржнрж░ржгрзА":"рж╢рзБржХрзНрж░","ржХрзГрждрзНрждрж┐ржХрж╛":"рж╕рзВрж░рзНржп","рж░рзЛрж╣рж┐ржгрзА":"ржЪржирзНржжрзНрж░","ржорзГржЧрж╢рж┐рж░рж╛":"ржоржЩрзНржЧрж▓","ржЖржжрзНрж░рж╛":"рж░рж╛рж╣рзБ","ржкрзБржирж░рзНржмрж╕рзВ":"ржмрзГрж╣рж╕рзНржкрждрж┐","ржкрзБрж╖рзНржпрж╛":"рж╢ржирж┐","ржЖрж╢рзНрж▓рзЗрж╖рж╛":"ржмрзБржз","ржоржШрж╛":"ржХрзЗрждрзБ","ржкрзВрж░рзНржмржлрж╛рж▓рзНржЧрзБржирзА":"рж╢рзБржХрзНрж░","ржЙрждрзНрждрж░ржлрж╛рж▓рзНржЧрзБржирзА":"рж╕рзВрж░рзНржп","рж╣рж╕рзНрждрж╛":"ржЪржирзНржжрзНрж░","ржЪрж┐рждрзНрж░рж╛":"ржоржЩрзНржЧрж▓","рж╕рзНржмрж╛рждрзА":"рж░рж╛рж╣рзБ","ржмрж┐рж╢рж╛ржЦрж╛":"ржмрзГрж╣рж╕рзНржкрждрж┐","ржЕржирзБрж░рж╛ржзрж╛":"рж╢ржирж┐","ржЬрзНржпрзЗрж╖рзНржарж╛":"ржмрзБржз","ржорзВрж▓рж╛":"ржХрзЗрждрзБ","ржкрзВрж░рзНржмрж╛рж╖рж╛рзЭрж╛":"рж╢рзБржХрзНрж░","ржЙрждрзНрждрж░рж╛рж╖рж╛рзЭрж╛":"рж╕рзВрж░рзНржп","рж╢рзНрж░ржмржгрж╛":"ржЪржирзНржжрзНрж░","ржзржирж┐рж╖рзНржарж╛":"ржоржЩрзНржЧрж▓","рж╢рждржнрж┐рж╖рж╛":"рж░рж╛рж╣рзБ","ржкрзВрж░рзНржмржнрж╛ржжрзНрж░ржкржж":"ржмрзГрж╣рж╕рзНржкрждрж┐","ржЙрждрзНрждрж░ржнрж╛ржжрзНрж░ржкржж":"рж╢ржирж┐","рж░рзЗржмрждрзА":"ржмрзБржз"}[NAK[nIdx]] || 'тАФ'
            }</div>
          </div>

          <div style="margin-top:10px" class="progressWrap">
            <div style="font-weight:900;margin-bottom:8px">рж░рж╛рж╢рж┐ ржкрзНрж░ржЧрзНрж░рзЗрж╕</div>
            <div class="progressBar"><div id="rashiFill" class="progressFill" style="width:0%"></div></div>
            <div class="progressLabel"><div id="rashiPos">тАФ</div><div id="rashiPct">тАФ</div></div>
          </div>
        </div>

        <div class="footer">Latitude ${lat.toFixed(2)}┬░, Longitude ${lon.toFixed(2)}┬░ ┬╖ Auto refresh: ржкрзНрж░рждрж┐ 60 ржорж┐ржирж┐ржЯрзЗ ┬╖ ржкржЮрзНржЬрж┐ржХрж╛ ржорзЛржб: ${MODE==="drik" ? "ржжрзГржХ (Govt)" : "рж╕рзВрж░рзНржпрж╕рж┐ржжрзНржзрж╛ржирзНржд"}</div>
      </section>

      <section class="card" style="margin-top:8px">
        <div style="font-weight:900">ЁЯМК ржЖржЬржХрзЗрж░ ржЬрзЛржпрж╝рж╛рж░-ржнрж╛ржЯрж╛ <span style="font-weight:800;color:var(--muted)">(${tide.source})</span></div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <div style="flex:1;min-width:140px;background:#eaf3ff;border-radius:8px;padding:8px"><div style="font-weight:800">ржЙржЪрзНржЪ ржЬрзЛржпрж╝рж╛рж░ рзз</div><div style="font-weight:900">${fmt12(tide.h1)}</div></div>
          <div style="flex:1;min-width:140px;background:#eaf3ff;border-radius:8px;padding:8px"><div style="font-weight:800">ржЙржЪрзНржЪ ржЬрзЛржпрж╝рж╛рж░ рзи</div><div style="font-weight:900">${fmt12(tide.h2)}</div></div>
          <div style="flex:1;min-width:140px;background:#eaf3ff;border-radius:8px;padding:8px"><div style="font-weight:800">ржирж┐ржорзНржи ржнрж╛ржЯрж╛ рзз</div><div style="font-weight:900">${fmt12(tide.l1)}</div></div>
          <div style="flex:1;min-width:140px;background:#eaf3ff;border-radius:8px;padding:8px"><div style="font-weight:800">ржирж┐ржорзНржи ржнрж╛ржЯрж╛ рзи</div><div style="font-weight:900">${fmt12(tide.l2)}</div></div>
        </div>
      </section>
    `;

    // set live clock display
    const tzFmt = new Intl.DateTimeFormat('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true,timeZoneName:'short'});
    document.getElementById('lt').textContent = "тП░ Local Time тАФ " + tzFmt.format(now);

    // Fill rashi progress (approx): compute moon's sidereal longitude within sign (0-30)
    const ay = MODE_PARAMS[MODE].ayan(JEval);
    const moonSid = norm(correctedMoonLong(JEval, MODE) - ay); // 0-360
    const signIndex = Math.floor(moonSid / 30);
    const signDeg = moonSid - signIndex*30;
    const pct = Math.round((signDeg / 30) * 100);
    document.getElementById('rashiFill').style.width = pct + '%';
    document.getElementById('rashiPos').textContent = `${NAK[nIdx]} ┬╖ ${Math.floor(signDeg)}┬░ ${Math.round((signDeg%1)*60)}'`;
    document.getElementById('rashiPct').textContent = pct + '%';

    /* Toggle logic: knob moves under labels and shows which is selected.
       We ensure knob rests under the chosen label and label text remains visible. */
    const knob = document.getElementById('knob'), track = document.getElementById('toggleTrack');
    function updateKnobVisual(){
      if(MODE === 'drik'){
        knob.classList.add('right');
        knob.textContent = 'ржжрзГржХ';
      } else {
        knob.classList.remove('right');
        knob.textContent = 'рж╕рзВрж░рзНржп';
      }
    }
    updateKnobVisual();
    track.onclick = () => {
      setMode(MODE === 'drik' ? 'surya' : 'drik');
      // small visual + reload to recompute engine safely
      updateKnobVisual();
      setTimeout(()=> location.reload(), 350);
    };

    /* Auto refresh policy:
       - Default every 60 minutes (user asked sometimes 3 hours, but 60min gives faster tithi updates).
       - Also schedule a reload near next tithi/nak end (whichever comes first).
    */
    setInterval(()=> location.reload(), 1000*60*60); // 60 minutes

    // schedule reload at next event
    const nowH = now.getHours() + now.getMinutes()/60 + now.getSeconds()/3600;
    const delayT = ((tEndLocal - nowH + 24) % 24) * 3600 * 1000;
    const delayN = ((nEndLocal - nowH + 24) % 24) * 3600 * 1000;
    const soon = Math.min(delayT || Infinity, delayN || Infinity);
    if(isFinite(soon) && soon > 1000*30){
      setTimeout(()=> location.reload(), Math.max(30*1000, soon - 2000)); // small margin
    }

    // final: ensure fonts / style tweaks for accessibility
    // (already inlined тАФ nothing further)

  }catch(err){
    // show error gracefully
    console.error(err);
    document.getElementById('root').innerHTML = `<div class="card"><div style="text-align:center;font-weight:900;color:#b00020">ржХрж┐ржЫрзБ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗ тАФ ржкрзЗржЬ рж░рж┐рж▓рзЛржб ржХрж░рзБржиред</div><div style="text-align:center;margin-top:8px">${err.message || ''}</div></div>`;
  }
})();

/* ===== End of Part B ===== */
</script>
</body>
</html>
